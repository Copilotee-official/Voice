<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniMax TTS - 增强版</title>
<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  max-width: 850px;
  margin: 0 auto;
  padding: 20px;
  background-color: #f5f9ff;
  color: #333;
}

.container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 20px;
}

h1, h2, h3 {
  color: #2c3e50;
}

.form-group {
  margin-bottom: 15px;
}

label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #4a6fa5;
}

input, select, textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  box-sizing: border-box;
}

textarea {
  resize: vertical;
  min-height: 100px;
}

button {
  background: #4a6fa5;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
  margin-right: 5px;
  margin-bottom: 5px;
}

button:hover {
  background: #3a5a80;
}

button:disabled {
  background: #cccccc;
  cursor: not-allowed;
}

.secondary-btn {
  background: #6c757d;
}

.success-btn {
  background: #28a745;
}

.danger-btn {
  background: #dc3545;
}

.logs {
  background: #1e272e;
  color: #f5f6fa;
  padding: 15px;
  border-radius: 5px;
  font-family: monospace;
  height: 200px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.log-entry {
  margin-bottom: 5px;
  border-bottom: 1px solid #34495e;
  padding-bottom: 5px;
}

.log-info { color: #3498db; }
.log-success { color: #2ecc71; }
.log-error { color: #e74c3c; }
.log-warning { color: #f39c12; }
.log-debug { color: #9b59b6; }

.audio-container {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 4px;
}

audio {
  width: 100%;
  margin-bottom: 10px;
}

.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.slider-container {
  display: flex;
  align-items: center;
}

.slider {
  flex: 1;
  margin-right: 10px;
}

.slider-value {
  width: 50px;
  text-align: center;
  font-weight: bold;
}

.section {
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 15px;
  margin-bottom: 20px;
  background: #fff;
}

.section-title {
  margin-top: 0;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  color: #4a6fa5;
}

/* 音色克隆样式 */
.file-input-container {
  position: relative;
  margin-top: 10px;
  margin-bottom: 15px;
}

.file-input-label {
  display: inline-block;
  padding: 8px 15px;
  background: #5d7ea8;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s;
}

.file-input-label:hover {
  background: #4a6fa5;
}

.file-input {
  position: absolute;
  width: 0.1px;
  height: 0.1px;
  opacity: 0;
  overflow: hidden;
  z-index: -1;
}

.file-name {
  margin-left: 10px;
  font-style: italic;
  color: #666;
}

.id-validation {
  color: #6c757d;
  font-size: 0.9em;
  margin-top: 5px;
}

.validation-item {
  margin-bottom: 2px;
}

.validation-item.pass {
  color: #28a745;
}

.validation-item.fail {
  color: #dc3545;
}

.custom-voice-list {
  margin-top: 15px;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
}

.custom-voice-item {
  padding: 8px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.custom-voice-item:last-child {
  border-bottom: none;
}

.custom-voice-name {
  font-weight: bold;
}

.custom-voice-date {
  color: #666;
  font-size: 0.9em;
}

.custom-voice-controls {
  display: flex;
  gap: 5px;
}

/* 批量处理相关样式 */
.batch-progress {
  width: 100%;
  height: 20px;
  background-color: #f0f0f0;
  border-radius: 4px;
  margin-top: 10px;
  overflow: hidden;
}

.batch-progress-bar {
  height: 100%;
  background-color: #4caf50;
  width: 0%;
  transition: width 0.3s;
}

.batch-status {
  display: flex;
  justify-content: space-between;
  margin-top: 5px;
  font-size: 14px;
}

.batch-container {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.batch-results {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
}

.batch-item {
  padding: 5px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
}

.batch-item:last-child {
  border-bottom: none;
}

.batch-item.success {
  background-color: #f1f8e9;
}

.batch-item.error {
  background-color: #ffebee;
}

.info-box {
  background-color: #d1ecf1;
  border: 1px solid #bee5eb;
  border-radius: 4px;
  padding: 10px;
  margin-bottom: 15px;
  color: #0c5460;
}

.two-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

@media (max-width: 768px) {
  .two-columns {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="container">
  <h1>MiniMax TTS - 增强版</h1>
  
  <div class="section">
    <h2 class="section-title">文本转语音</h2>
    <div class="form-group">
      <label for="textContent">文本内容</label>
      <textarea id="textContent" placeholder="请输入要转换为语音的文本...">嗨，这是一段测试语音，使用MiniMax TTS生成。</textarea>
    </div>
    
    <div class="two-columns">
      <div class="form-group">
        <label for="model">模型选择</label>
        <select id="model">
          <option value="speech-02-hd" selected>speech-02-hd（高清版）</option>
          <option value="speech-02-turbo">speech-02-turbo（高速版）</option>
          <option value="speech-01-hd">speech-01-hd（旧高清版）</option>
          <option value="speech-01-turbo">speech-01-turbo（旧高速版）</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="voiceId">音色选择</label>
        <select id="voiceId">
          <!-- 官方预设音色 -->
          <option value="sm_0421_king_30s">sm_0421_king_30s（默认男声）</option>
          <option value="male-qn-qingse">male-qn-qingse（青涩男声）</option>
          <option value="female-shaonv">female-shaonv（少女音）</option>
          <option value="female-yujie">female-yujie（玉洁音）</option>
          <option value="male-yifei">male-yifei（逸飞音）</option>
          <option value="blackswan">blackswan（黑天鹅）</option>
          <option value="JayChou_hailuo">JayChou_hailuo（周杰伦音色）</option>
          <option value="Leijun_hailuo">Leijun_hailuo（雷军音色）</option>
          <!-- 增加的系统默认音色 -->
          <option value="male-qn-jingying">male-qn-jingying（精英青年音色）</option>
          <option value="male-qn-badao">male-qn-badao（霸道青年音色）</option>
          <option value="male-qn-daxuesheng">male-qn-daxuesheng（青年大学生音色）</option>
          <option value="female-chengshu">female-chengshu（成熟女性音色）</option>
          <option value="female-tianmei">female-tianmei（甜美女性音色）</option>
          <option value="presenter_male">presenter_male（男性主持人）</option>
          <option value="presenter_female">presenter_female（女性主持人）</option>
          <option value="audiobook_male_1">audiobook_male_1（男性有声书1）</option>
          <option value="audiobook_male_2">audiobook_male_2（男性有声书2）</option>
          <option value="audiobook_female_1">audiobook_female_1（女性有声书1）</option>
          <option value="audiobook_female_2">audiobook_female_2（女性有声书2）</option>
          <option value="male-qn-qingse-jingpin">male-qn-qingse-jingpin（青涩青年音色-精品）</option>
          <option value="male-qn-jingying-jingpin">male-qn-jingying-jingpin（精英青年音色-精品）</option>
          <option value="male-qn-badao-jingpin">male-qn-badao-jingpin（霸道青年音色-精品）</option>
          <option value="male-qn-daxuesheng-jingpin">male-qn-daxuesheng-jingpin（青年大学生音色-精品）</option>
          <option value="female-shaonv-jingpin">female-shaonv-jingpin（少女音色-精品）</option>
          <option value="female-yujie-jingpin">female-yujie-jingpin（御姐音色-精品）</option>
          <option value="female-chengshu-jingpin">female-chengshu-jingpin（成熟女性音色-精品）</option>
          <option value="female-tianmei-jingpin">female-tianmei-jingpin（甜美女性音色-精品）</option>
          <option value="clever_boy">clever_boy（聪明男童）</option>
          <option value="cute_boy">cute_boy（可爱男童）</option>
          <option value="lovely_girl">lovely_girl（萌萌女童）</option>
          <option value="cartoon_pig">cartoon_pig（卡通猪小琪）</option>
          <option value="bingjiao_didi">bingjiao_didi（病娇弟弟）</option>
          <option value="junlang_nanyou">junlang_nanyou（俊朗男友）</option>
          <option value="chunzhen_xuedi">chunzhen_xuedi（纯真学弟）</option>
          <option value="lengdan_xiongzhang">lengdan_xiongzhang（冷淡学长）</option>
          <option value="badao_shaoye">badao_shaoye（霸道少爷）</option>
          <option value="tianxin_xiaoling">tianxin_xiaoling（甜心小玲）</option>
          <option value="qiaopi_mengmei">qiaopi_mengmei（俏皮萌妹）</option>
          <option value="wumei_yujie">wumei_yujie（妩媚御姐）</option>
          <option value="diadia_xuemei">diadia_xuemei（嗲嗲学妹）</option>
          <option value="danya_xuejie">danya_xuejie（淡雅学姐）</option>
          <option value="Santa_Claus">Santa_Claus（圣诞老人）</option>
          <option value="Grinch">Grinch（格林奇）</option>
          <option value="Rudolph">Rudolph（鲁道夫）</option>
          <option value="Arnold">Arnold（阿诺德）</option>
          <option value="Charming_Santa">Charming_Santa（迷人的圣诞老人）</option>
          <option value="Charming_Lady">Charming_Lady（迷人的女士）</option>
          <option value="Sweet_Girl">Sweet_Girl（甜美女孩）</option>
          <option value="Cute_Elf">Cute_Elf（可爱精灵）</option>
          <option value="Attractive_Girl">Attractive_Girl（有魅力的女孩）</option>
          <option value="Serene_Woman">Serene_Woman（宁静女性）</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="speed">语速调节: <span id="speedValue">1.0</span></label>
      <div class="slider-container">
        <input type="range" id="speed" class="slider" min="0.5" max="2.0" step="0.05" value="1.0" oninput="updateSliderValue('speed', 'speedValue')">
      </div>
    </div>
    
    <div class="form-group">
      <label for="vol">音量调节: <span id="volValue">1.0</span></label>
      <div class="slider-container">
        <input type="range" id="vol" class="slider" min="0.1" max="10.0" step="0.1" value="1.0" oninput="updateSliderValue('vol', 'volValue')">
      </div>
    </div>
    
    <div class="form-group">
      <label for="pitch">语调调节: <span id="pitchValue">0</span></label>
      <div class="slider-container">
        <input type="range" id="pitch" class="slider" min="-12" max="12" step="1" value="0" oninput="updateSliderValue('pitch', 'pitchValue')">
      </div>
    </div>
    
    <div class="form-group">
      <label for="emotion">情绪选择</label>
      <select id="emotion">
        <option value="">不使用情绪</option>
        <option value="happy">高兴</option>
        <option value="sad">悲伤</option>
        <option value="angry">愤怒</option>
        <option value="fearful">害怕</option>
        <option value="disgusted">厌恶</option>
        <option value="surprised">惊讶</option>
        <option value="neutral">中性</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="outputFormat">输出格式</label>
      <select id="outputFormat">
        <option value="mp3" selected>MP3</option>
        <option value="wav">WAV</option>
        <option value="pcm">PCM</option>
        <option value="flac">FLAC</option>
      </select>
    </div>
    
    <div class="form-group">
      <div class="two-columns">
        <div>
          <input type="checkbox" id="latexRead" style="width: auto;">
          <label for="latexRead" style="display: inline;">支持朗读LaTeX公式</label>
        </div>
        <div>
          <input type="checkbox" id="englishNormalization" style="width: auto;">
          <label for="englishNormalization" style="display: inline;">英语文本规范化</label>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <button id="generateBtn" onclick="generateSpeech()">生成语音</button>
      <button onclick="clearLogs()" class="secondary-btn">清除日志</button>
      <button onclick="displayAllAvailableVoiceIds()" class="secondary-btn">显示所有音色</button>
      <button onclick="displayAllClonedVoiceIds()" class="secondary-btn">显示克隆音色</button>
    </div>
    
    <div class="audio-container" id="audioContainer" style="display: none;">
      <h3>生成结果</h3>
      <audio id="audioPlayer" controls></audio>
      <div style="margin-top: 10px;">
        <button onclick="downloadAudio()" class="success-btn">下载音频</button>
        <button onclick="repeatPlayback()" class="secondary-btn">重复播放</button>
      </div>
    </div>
  </div>
  
  <div class="section">
    <h2 class="section-title">批量处理</h2>
    <div class="info-box">
      <p><strong>批量处理说明：</strong></p>
      <p>1. 上传TXT文本文件，每行一句话</p>
      <p>2. 系统将使用当前设置的音色和参数为每一行生成对应音频</p>
      <p>3. 生成完成后可下载包含所有文本和音频的ZIP文件</p>
    </div>
    
    <div class="form-group">
      <label for="batchFile">选择TXT文本文件</label>
      <div class="file-input-container">
        <label for="batchFile" class="file-input-label">选择文件</label>
        <input type="file" id="batchFile" class="file-input" accept=".txt" onchange="handleBatchFileSelect(this)">
        <span id="batchFileName" class="file-name">未选择文件</span>
      </div>
    </div>
    
    <div class="form-group">
      <label for="outputFolder">输出文件夹名称</label>
      <input type="text" id="outputFolder" value="tts_output" placeholder="生成的ZIP文件名称">
    </div>
    
    <div class="form-group">
      <label for="batchConcurrency">并发数量</label>
      <select id="batchConcurrency">
        <option value="1">1 (低负载)</option>
        <option value="2">2</option>
        <option value="3" selected>3 (推荐)</option>
        <option value="5">5 (高负载)</option>
      </select>
    </div>
    
    <div class="form-group">
      <button id="startBatchBtn" onclick="startBatchProcess()" disabled>开始批量生成</button>
      <button id="stopBatchBtn" onclick="stopBatchProcess()" disabled class="danger-btn">停止生成</button>
    </div>
    
    <div id="batchContainer" class="batch-container" style="display: none;">
      <h3>批量处理进度</h3>
      <div class="batch-progress">
        <div id="batchProgressBar" class="batch-progress-bar"></div>
      </div>
      <div class="batch-status">
        <span id="batchProgressText">准备中...</span>
        <span id="batchCountText">0/0</span>
      </div>
      
      <div id="batchResults" class="batch-results">
        <!-- 批量处理结果将显示在这里 -->
      </div>
      
      <div style="margin-top: 15px; display: none;" id="batchDownloadDiv">
        <button onclick="downloadBatchResults()" class="success-btn">下载所有结果(ZIP)</button>
      </div>
    </div>
  </div>
  
  <div class="section">
    <h2 class="section-title">音色克隆</h2>
    <div class="form-group">
      <label for="customVoiceId">自定义音色ID</label>
      <input type="text" id="customVoiceId" placeholder="请输入8-256个字符，字母开头" oninput="validateVoiceId()">
      <div id="idValidation" class="id-validation">
        <div class="validation-item" id="validLength">• 长度需要在8-256个字符之间</div>
        <div class="validation-item" id="validStart">• 必须以字母开头</div>
        <div class="validation-item" id="validChars">• 只允许字母、数字、连字符(-)和下划线(_)</div>
        <div class="validation-item" id="validEnd">• 末位字符不能是连字符(-)或下划线(_)</div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="cloneAudioFile">上传音频文件 (MP3/M4A/WAV，10秒-5分钟，<20MB)</label>
      <div class="file-input-container">
        <label for="cloneAudioFile" class="file-input-label">选择文件</label>
        <input type="file" id="cloneAudioFile" class="file-input" accept=".mp3,.m4a,.wav" onchange="validateAudioFile(this, 'cloneFileName')">
        <span id="cloneFileName" class="file-name">未选择文件</span>
      </div>
      <div id="audioFileValidation"></div>
    </div>
    
    <div class="form-group">
      <button id="startCloneBtn" onclick="startVoiceClone()">开始克隆</button>
    </div>
    
    <h3>我的克隆音色</h3>
    <div id="customVoiceList" class="custom-voice-list">
      <div class="log-entry log-info">暂无克隆音色，请使用上方表单创建。</div>
    </div>
  </div>
  
  <div class="logs" id="logs">
    <div class="log-entry log-info">准备就绪，请设置参数并输入文本...</div>
  </div>
</div>

<!-- JSZip 库 -->
<script>
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=e()}}(function(){return function e(t,r,n){function i(s,a){if(!r[s]){if(!t[s]){var o="function"==typeof require&&require;if(!a&&o)return o(s,!0);if(f)return f(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var u=r[s]={exports:{}};t[s][0].call(u.exports,function(e){var r=t[s][1][e];return i(r||e)},u,u.exports,e,t,r,n)}return r[s].exports}for(var f="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./support"),f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(e){for(var t,r,i,s,a,o,h,u=[],l=0,c=e.length,d=c,p="string"!==n.getTypeOf(e);l<e.length;)d=c-l,i=p?(t=e[l++],r=l<c?e[l++]:0,l<c?e[l++]:0):(t=e.charCodeAt(l++),r=l<c?e.charCodeAt(l++):0,l<c?e.charCodeAt(l++):0),s=t>>2,a=(3&t)<<4|r>>4,o=1<d?(15&r)<<2|i>>6:64,h=2<d?63&i:64,u.push(f.charAt(s)+f.charAt(a)+f.charAt(o)+f.charAt(h));return u.join("")},r.decode=function(e){var t,r,n,s,a,o,h=0,u=0;if("data:"===e.substr(0,"data:".length))throw new Error("Invalid base64 input, it looks like a data url.");var l,c=3*(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(e.charAt(e.length-1)===f.charAt(64)&&c--,e.charAt(e.length-2)===f.charAt(64)&&c--,c%1!=0)throw new Error("Invalid base64 input, bad content length.");for(l=i.uint8array?new Uint8Array(0|c):new Array(0|c);h<e.length;)s=f.indexOf(e.charAt(h++))<<2|(a=f.indexOf(e.charAt(h++)))>>4,r=(15&a)<<4|(o=f.indexOf(e.charAt(h++)))>>2,n=(3&o)<<6|(t=f.indexOf(e.charAt(h++))),l[u++]=s,64!==o&&(l[u++]=r),64!==t&&(l[u++]=n);return l}},{"./support":30,"./utils":32}],2:[function(e,t,r){"use strict";var n=e("./external"),i=e("./stream/DataWorker"),f=e("./stream/DataLengthProbe"),s=e("./stream/Crc32Probe");function a(e,t,r,n,i){this.compressedSize=e,this.uncompressedSize=t,this.crc32=r,this.compression=n,this.compressedContent=i}a.prototype={getContentWorker:function(){var e=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new f("data_length")),t=this;return e.on("end",function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),e},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},a.createWorkerFrom=function(e,t,r){return e.pipe(new s).pipe(new f("uncompressedSize")).pipe(t.compressWorker(r)).pipe(new f("compressedSize")).withStreamInfo("compression",t)},t.exports=a},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,r){"use strict";var n=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,r){"use strict";var n=e("./utils");function i(e){if(!(this instanceof i))throw new TypeError("Cannot call a class as a function");if(!e)throw new Error("No input string given");this.data=e,this.length=e.length,this.index=0}i.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<e)throw this.RangeError(e)},RangeError:function(e){return new Error("End of data reached (data length = "+this.length+", asked index = "+e+")")},byteAt:function(e){return this.data.charCodeAt(e)},readByte:function(){return this.byteAt(this.index++)},readInt:function(e){var t=0;for(this.checkOffset(e),e=this.index+e-1;e>=this.index;e--)t=(t<<8)+this.byteAt(e);return this.index+=e-this.index+1,t},readString:function(e){return n.transformTo("string",this.readData(e))},readData:function(e){for(var t=this.data,r=this.index,n=r+e,i="",f=r;f<n;f++)i+=String.fromCharCode(this.byteAt(f));return this.index=n,i},lastIndexOfSignature:function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),f=this.length-4;f>=0;--f)if(this.byteAt(f)===t&&this.byteAt(f+1)===r&&this.byteAt(f+2)===n&&this.byteAt(f+3)===i)return f;return-1},readAndCheckSignature:function(e){var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),f=this.readData(4);return t===f.charCodeAt(0)&&r===f.charCodeAt(1)&&n===f.charCodeAt(2)&&i===f.charCodeAt(3)}},t.exports=i},{"./utils":32}],5:[function(e,t,r){"use strict";r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,t,r){"use strict";var n=null;n="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:n}},{lie:37}],7:[function(e,t,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,i=e("pako"),f=e("./utils"),s=e("./stream/GenericWorker"),a=n?"uint8array":"array";function o(e,t){s.call(this,"FlateWorker/"+e),this._pako=null,this._pakoAction=e,this._pakoOptions=t,this.meta={}}r.magic="\b\0",f.inherits(o,s),o.prototype.processChunk=function(e){this.meta=e.meta,null===this._pako&&this._createPako(),this._pako.push(f.transformTo(a,e.data),!1)},o.prototype.flush=function(){s.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},o.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},o.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var t=this;this._pako.onData=function(e){t.push({data:e,meta:t.meta})}},r.compressWorker=function(e){return new o("Deflate",e)},r.uncompressWorker=function(){return new o("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,t,r){"use strict";function n(e,t){var r,n="";for(r=0;r<t;r++)n+=String.fromCharCode(255&e),e>>>=8;return n}function i(e,t,r,i,f,s){var a,o,h=e.file,u=e.compression,l=s!==U.utf8encode,c=d.transformTo("string",s(h.name)),p=d.transformTo("string",U.utf8encode(h.name)),m=h.comment,_=d.transformTo("string",s(m)),g=d.transformTo("string",U.utf8encode(m)),b=p.length!==h.name.length,v=g.length!==m.length,w="",y="",k="",x=h.dir,S=h.date,z={crc32:0,compressedSize:0,uncompressedSize:0};t&&!r||(z.crc32=e.crc32,z.compressedSize=e.compressedSize,z.uncompressedSize=e.uncompressedSize);var C=0;t&&(C|=8),l||!b&&!v||(C|=2048);var E=0,A=0;x&&(E|=16),"UNIX"===f?(A=798,E|=function(e,t){var r=e;return e||(r=t?16893:33204),(65535&r)<<16}(h.unixPermissions,x)):(A=20,E|=function(e){return 63&(e||0)}(h.dosPermissions)),a=S.getUTCHours(),a<<=6,a|=S.getUTCMinutes(),a<<=5,a|=S.getUTCSeconds()/2,o=S.getUTCFullYear()-1980,o<<=4,o|=S.getUTCMonth()+1,o<<=5,o|=S.getUTCDate(),b&&(y=n(1,1)+n(D(c),4)+p,w+="up"+n(y.length,2)+y),v&&(k=n(1,1)+n(D(_),4)+g,w+="uc"+n(k.length,2)+k);var I="";return I+="\n\0",I+=n(C,2),I+=u.magic,I+=n(a,2),I+=n(o,2),I+=n(z.crc32,4),I+=n(z.compressedSize,4),I+=n(z.uncompressedSize,4),I+=n(c.length,2),I+=n(w.length,2),{fileRecord:O.LOCAL_FILE_HEADER+I+c+w,dirRecord:O.CENTRAL_FILE_HEADER+n(A,2)+I+n(_.length,2)+"\0\0\0\0"+n(E,4)+n(i,4)+c+w+_}}var d=e("../utils"),f=e("../stream/GenericWorker"),U=e("../utf8"),D=e("../crc32"),O=e("../signature");function s(e,t,r,n){f.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=r,this.encodeFileName=n,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}d.inherits(s,f),s.prototype.push=function(e){var t=e.meta.percent||0,r=this.entriesCount,n=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,f.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:r?(t+100*(r-n-1))/r:100}}))},s.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var r=i(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}})}else this.accumulate=!0},s.prototype.closedSource=function(e){this.accumulate=!1;var t=this.streamFiles&&!e.file.dir,r=i(e,t,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),t)this.push({data:function(e){return O.DATA_DESCRIPTOR+n(e.crc32,4)+n(e.compressedSize,4)+n(e.uncompressedSize,4)}(e),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},s.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var r=this.bytesWritten-e,i=function(e,t,r,i,f){var s=d.transformTo("string",f(i));return O.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(e,2)+n(e,2)+n(t,4)+n(r,4)+n(s.length,2)+s}(this.dirRecords.length,r,e,this.zipComment,this.encodeFileName);this.push({data:i,meta:{percent:100}})},s.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},s.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()}),e.on("error",function(e){t.error(e)}),this},s.prototype.resume=function(){return!!f.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},s.prototype.error=function(e){var t=this._sources;if(!f.prototype.error.call(this,e))return!1;for(var r=0;r<t.length;r++)try{t[r].error(e)}catch(e){}return!0},s.prototype.lock=function(){f.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=s},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,r){"use strict";var n=e("../compressions"),i=e("./ZipFileWorker");r.generateWorker=function(e,f,t){var s=new i(f.streamFiles,t,f.platform,f.encodeFileName),a=0;try{e.forEach(function(e,t){a++;var r=function(e,t){var r=e||t,i=n[r];if(!i)throw new Error(r+" is not a valid compression method !");return i}(t.options.compression,f.compression),i=t.options.compressionOptions||f.compressionOptions||{},o=t.dir,h=t.date;t._compressWorker(r,i).withStreamInfo("file",{name:e,dir:o,date:h,comment:t.comment||"",unixPermissions:t.unixPermissions,dosPermissions:t.dosPermissions}).pipe(s)}),s.entriesCount=a}catch(e){s.error(e)}return s}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,r){"use strict";function i(){if(!(this instanceof i))return new i;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var e=new i;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}(i.prototype=e("./object")).loadAsync=e("./load"),i.support=e("./support"),i.defaults=e("./defaults"),i.version="3.7.1",i.loadAsync=function(e,t){return(new i).loadAsync(e,t)},i.external=e("./external"),t.exports=i},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./external"),f=e("./utf8"),s=e("./zipEntries"),a=e("./stream/Crc32Probe"),o=e("./nodejsUtils");function h(n){return new i.Promise(function(e,t){var r=n.decompressed.getContentWorker().pipe(new a);r.on("error",function(e){t(e)}).on("end",function(){r.streamInfo.crc32!==n.decompressed.crc32?t(new Error("Corrupted zip : CRC32 mismatch")):e()}).resume()})}t.exports=function(e,l){var c=this;return l=n.extend(l||{},{base64:!1,checkCRC32:!0,optimizedBinaryString:!1,createFolders:!1,decodeFileName:f.utf8decode}),o.isNode&&o.isStream(e)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",e,!0,l.optimizedBinaryString,l.base64).then(function(e){var t=new s(l);return t.load(e),t}).then(function(e){var t=[i.Promise.resolve(e)],r=e.files;if(l.checkCRC32)for(var n=0;n<r.length;n++)t.push(h(r[n]));return i.Promise.all(t)}).then(function(e){for(var t=e.shift(),r=t.files,n=0;n<r.length;n++){var i=r[n];c.file(i.fileNameStr,i.decompressed,{binary:!0,optimizedBinaryString:!0,date:i.date,dir:i.dir,comment:i.fileCommentStr.length?i.fileCommentStr:null,unixPermissions:i.unixPermissions,dosPermissions:i.dosPermissions,createFolders:l.createFolders})}return t.zipComment.length&&(c.comment=t.zipComment),c})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,r){"use strict";var n=e("../utils"),i=e("../stream/GenericWorker");function f(e,t){i.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}n.inherits(f,i),f.prototype._bindStream=function(e){var t=this;(this._stream=e).pause(),e.on("data",function(e){t.push({data:e,meta:{percent:0}})}).on("error",function(e){t.isPaused?this.generatedError=e:t.error(e)}).on("end",function(){t.isPaused?t._upstreamEnded=!0:t.end()})},f.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},f.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=f},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,r){"use strict";var n=e("readable-stream").Readable;function i(e,t,r){n.call(this,t),this._helper=e;var i=this;e.on("data",function(e,t){i.push(e)||i._helper.pause(),r&&r(t)}).on("error",function(e){i.emit("error",e)}).on("end",function(){i.push(null)})}e("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume()},t.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,t,r){"use strict";t.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(e,t){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(e,t);if("number"==typeof e)throw new Error('The "data" argument must not be a number');return new Buffer(e,t)},allocBuffer:function(e){if(Buffer.alloc)return Buffer.alloc(e);var t=new Buffer(e);return t.fill(0),t},isBuffer:function(e){return Buffer.isBuffer(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,r){"use strict";function f(e,t,r){var n,i=o.getTypeOf(t),f=o.extend(r||{},h);f.date=f.date||new Date,null!==f.compression&&(f.compression=f.compression.toUpperCase()),"string"==typeof f.unixPermissions&&(f.unixPermissions=parseInt(f.unixPermissions,8)),f.unixPermissions&&16384&f.unixPermissions&&(f.dir=!0),f.dosPermissions&&16&f.dosPermissions&&(f.dir=!0),f.dir&&(e=y(e)),f.createFolders&&(n=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""}(e))&&g.call(this,n,!0);var s="string"===i&&!1===f.binary&&!1===f.base64;r&&void 0!==r.binary||(f.binary=!s),(t instanceof c&&0===t.uncompressedSize||f.dir||!t||0===t.length)&&(f.base64=!1,f.binary=!0,t="",f.compression="STORE",i="string");var a=null;a=t instanceof c||t instanceof u?t:p.isNode&&p.isStream(t)?new m(e,t):o.prepareContent(e,t,f.binary,f.optimizedBinaryString,f.base64);var l=new d(e,a,f);this.files[e]=l}var s=e("./utf8"),a=e("./utils"),o=e("./stream/GenericWorker"),u=e("./stream/StreamHelper"),h=e("./defaults"),c=e("./compressedObject"),d=e("./zipObject"),l=e("./generate"),p=e("./nodejsUtils"),m=e("./nodejs/NodejsStreamInputAdapter"),_=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},y=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},g=function(e,t){return t=void 0!==t?t:h.createFolders,e=y(e),this.files[e]||f.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]};function b(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var v={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,r,n;for(t in this.files)this.files.hasOwnProperty(t)&&(n=this.files[t],(r=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(r,n))},filter:function(r){var n=[];return this.forEach(function(e,t){r(e,t)&&n.push(t)}),n},file:function(e,t,r){if(1!==arguments.length)return e=this.root+e,f.call(this,e,t,r),this;if(b(e)){var n=e;return this.filter(function(e,t){return!t.dir&&n.test(e)})}var i=this.files[this.root+e];return i&&!i.dir?i:null},folder:function(r){if(!r)return this;if(b(r))return this.filter(function(e,t){return t.dir&&r.test(e)});var e=this.root+r,t=g.call(this,e),n=this.clone();return n.root=t.name,n},remove:function(r){r=this.root+r;var e=this.files[r];if(e||("/"!==r.slice(-1)&&(r+="/"),e=this.files[r]),e&&!e.dir)delete this.files[r];else for(var t=this.filter(function(e,t){return t.name.slice(0,r.length)===r}),n=0;n<t.length;n++)delete this.files[t[n].name];return this},generate:function(e){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,r={};try{if((r=a.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");a.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var n=r.comment||this.comment||"";t=l.generateWorker(this,r,n)}catch(e){(t=new o("error")).error(e)}return new u(t,r.type||"string",r.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=v},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,r){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,r){"use strict";var n=e("./DataReader");function i(e){n.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}e("../utils").inherits(i,n),i.prototype.byteAt=function(e){return this.data[this.zero+e]},i.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===t&&this.data[f+1]===r&&this.data[f+2]===n&&this.data[f+3]===i)return f-this.zero;return-1},i.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),f=this.readData(4);return t===f[0]&&r===f[1]&&n===f[2]&&i===f[3]},i.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,t,r){"use strict";var n=e("../utils");function i(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){},readInt:function(e){var t,r=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)r=(r<<8)+this.byteAt(t);return this.index+=e,r},readString:function(e){return n.transformTo("string",this.readData(e))},readData:function(e){},lastIndexOfSignature:function(e){},readAndCheckSignature:function(e){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=i},{"../utils":32}],19:[function(e,t,r){"use strict";var n=e("./Uint8ArrayReader");function i(e){n.call(this,e)}e("../utils").inherits(i,n),i.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,r){"use strict";var n=e("./DataReader");function i(e){n.call(this,e)}e("../utils").inherits(i,n),i.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},i.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},i.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},i.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,t,r){"use strict";var n=e("./ArrayReader");function i(e){n.call(this,e)}e("../utils").inherits(i,n),i.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,r){"use strict";var n=e("../utils"),i=e("../support"),f=e("./ArrayReader"),s=e("./StringReader"),a=e("./NodeBufferReader"),o=e("./Uint8ArrayReader");t.exports=function(e){var t=n.getTypeOf(e);return n.checkSupport(t),"string"!==t||i.uint8array?i.nodebuffer&&"nodebuffer"===t?new a(e):i.uint8array&&(t===ArrayBuffer.name||"ArrayBuffer"===t||"Uint8Array"===t)?new o(n.transformTo("uint8array",e)):new f(n.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,r){"use strict";r.LOCAL_FILE_HEADER="PK\x03\x04",r.CENTRAL_FILE_HEADER="PK\x01\x02",r.CENTRAL_DIRECTORY_END="PK\x05\x06",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x06\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK\x06\x06",r.DATA_DESCRIPTOR="PK\x07\x08"},{}],24:[function(e,t,r){"use strict";var n=e("./GenericWorker"),i=e("../utils");function f(e){n.call(this,"ConvertWorker to "+e),this.destType=e}i.inherits(f,n),f.prototype.processChunk=function(e){this.push({data:i.transformTo(this.destType,e.data),meta:e.meta})},t.exports=f},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,r){"use strict";var n=e("./GenericWorker"),i=e("../crc32");function f(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}i.inherits(f,n),f.prototype.processChunk=function(e){this.streamInfo.crc32=i(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=f},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,r){"use strict";var n=e("../utils"),i=e("./GenericWorker");function f(e){i.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}n.inherits(f,i),f.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}i.prototype.processChunk.call(this,e)},t.exports=f},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,r){"use strict";var n=e("../utils"),i=e("./GenericWorker");function f(e){i.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then(function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=n.getTypeOf(e),t.isPaused||t._tickAndRepeat()},function(e){t.error(e)})}n.inherits(f,i),f.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},f.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},f.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},f.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=f},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,r){"use strict";function n(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}(n.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var r=0;r<this._listeners[e].length;r++)this._listeners[e][r].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.end()}),e.on("error",function(e){t.error(e)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var e=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}}).getStreamInfo=function(e){return this.streamInfo[e]},t.exports=n},{}],29:[function(e,t,r){"use strict";var n=e("../utils"),f=e("./ConvertWorker"),s=e("./GenericWorker"),a=e("../base64"),i=e("../support"),o=e("../external"),h=null;if(i.nodestream)try{h=e("../nodejs/NodejsStreamOutputAdapter")}catch(e){}function u(e,t,r){var i=t;switch(t){case"blob":case"arraybuffer":i="uint8array";break;case"base64":i="string"}try{this._internalType=i,this._outputType=t,this._mimeType=r,n.checkSupport(i),this._worker=e.pipe(new f(i)),e.lock()}catch(e){this._worker=new s("error"),this._worker.error(e)}}u.prototype={accumulate:function(e){return function(t,r){var i=new u(t,r.type,r.mimeType);return t.on("data",function(e){this.updateStatsAndPush(e)}.bind(this)),t.on("error",function(e){i.error(e)}.bind(this)),t.on("end",function(){this.flush()}.bind(this)),i}.bind(this)(e)},on:function(e,t){var r=this;return"data"===e?this._worker.on(e,function(e){t.call(r,e.data,e.meta)}):this._worker.on(e,function(){n.delay(t,arguments,r)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(n.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new h(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,r){"use strict";if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,r.nodebuffer="undefined"!=typeof Buffer,r.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)r.blob=!1;else{var n=new ArrayBuffer(0);try{r.blob=0===new Blob([n],{type:"application/zip"}).size}catch(e){try{var i=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,f=new i;f.append(n),r.blob=0===f.getBlob("application/zip").size}catch(e){r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch(e){r.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,s){"use strict";function a(){h.call(this,"utf-8 decode"),this.leftOver=null}function o(){h.call(this,"utf-8 encode")}for(var i=e("./utils"),h=e("./stream/GenericWorker"),u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=function(){for(var e,t=[],r=0;r<256;r++){for(var n=r,i=0;i<8;i++)n=1&n?3988292384^n>>>1:n>>>1;t[r]=n}return t}(),n=e("./support"),r=e("./nodejsUtils"),f=e("./stream/GenericWorker"),l=new Array(256),d=0;d<256;d++)l[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;l[254]=l[254]=1,s.utf8encode=function(e){if(n.nodebuffer)return r.newBufferFrom(e,"utf-8");return function(e){var t,r,n,i,f,s=e.length,a=0;for(i=0;i<s;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),a+=r<128?1:r<2048?2:r<65536?3:4;for(t=n.uint8array?new Uint8Array(a):new Array(a),i=f=0;f<a;i++)55296==(64512&(r=e.charCodeAt(i)))&&i+1<s&&56320==(64512&(n=e.charCodeAt(i+1)))&&(r=65536+(r-55296<<10)+(n-56320),i++),r<128?t[f++]=r:(r<2048?t[f++]=192|r>>>6:(r<65536?t[f++]=224|r>>>12:(t[f++]=240|r>>>18,t[f++]=128|r>>>12&63),t[f++]=128|r>>>6&63),t[f++]=128|63&r);return t}(e)},s.utf8decode=function(e){return n.nodebuffer?i.transformTo("nodebuffer",e).toString("utf-8"):function(e){var t,r,n,f,s=e.length,a=new Array(2*s);for(t=r=0;t<s;)if((n=e[t++])<128)a[r++]=n;else if(4<(f=l[n]))a[r++]=65533,t+=f-1;else{for(n&=2===f?31:3===f?15:7;1<f&&t<s;)n=n<<6|63&e[t++],f--;1<f?a[r++]=65533:n<65536?a[r++]=n:(n-=65536,a[r++]=55296|n>>10&1023,a[r++]=56320|1023&n)}return a.length!==r&&(a.subarray?a=a.subarray(0,r):a.length=r),function(e){var t="";return e.length<65537&&(t=String.fromCharCode.apply(null,e)),t}(a)}(e=i.transformTo(n.uint8array?"uint8array":"array",e))},i.inherits(a,h),a.prototype.processChunk=function(e){var t=i.transformTo(n.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var r=t;(t=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),t.set(r,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var f=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+l[e[r]]>t?r:t}(t),a=t;f!==t.length&&(n.uint8array?(a=t.subarray(0,f),this.leftOver=t.subarray(f,t.length)):(a=t.slice(0,f),this.leftOver=t.slice(f,t.length))),this.push({data:s.utf8decode(a),meta:e.meta})},a.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:s.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},s.Utf8DecodeWorker=a,i.inherits(o,h),o.prototype.processChunk=function(e){this.push({data:s.utf8encode(e.data),meta:e.meta})},s.Utf8EncodeWorker=o},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,a){"use strict";var o=e("./support"),h=e("./base64"),r=e("./nodejsUtils"),u=e("./external");function n(e){return e}function i(e,t){for(var r=0;r<e.length;++r)t[r]=255&e.charCodeAt(r);return t}e("setimmediate"),a.newBlob=function(t,r){a.checkSupport("blob");try{return new Blob([t],{type:r})}catch(e){try{var n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,i=new n;return i.append(t),i.getBlob(r)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var f={stringifyByChunk:function(e,t,r){var n=[],i=0,f=e.length;if(f<=r)return String.fromCharCode.apply(null,e);for(;i<f;)"array"===t||"nodebuffer"===t?n.push(String.fromCharCode.apply(null,e.slice(i,Math.min(i+r,f)))):n.push(String.fromCharCode.apply(null,e.subarray(i,Math.min(i+r,f)))),i+=r;return n.join("")},stringifyByChar:function(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},applyCanBeUsed:{uint8array:function(){try{return o.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return o.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch(e){return!1}}()}};function s(e){var t=65536,r=a.getTypeOf(e),n=!0;if("uint8array"===r?n=f.applyCanBeUsed.uint8array:"nodebuffer"===r&&(n=f.applyCanBeUsed.nodebuffer),n)for(;1<t;)try{return f.stringifyByChunk(e,r,t)}catch(e){t=Math.floor(t/2)}return f.stringifyByChar(e)}function l(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t}a.applyFromCharCode=s;var c={};c.string={string:n,array:function(e){return i(e,new Array(e.length))},arraybuffer:function(e){return c.string.uint8array(e).buffer},uint8array:function(e){return i(e,new Uint8Array(e.length))},nodebuffer:function(e){return i(e,r.allocBuffer(e.length))}},c.array={string:s,array:n,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(e)}},c.arraybuffer={string:function(e){return s(new Uint8Array(e))},array:function(e){return l(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:n,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(new Uint8Array(e))}},c.uint8array={string:s,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:n,nodebuffer:function(e){return r.newBufferFrom(e)}},c.nodebuffer={string:s,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return c.nodebuffer.uint8array(e).buffer},uint8array:function(e){return l(e,new Uint8Array(e.length))},nodebuffer:n},a.transformTo=function(e,t){if(t||(t=""),!e)return t;a.checkSupport(e);var r=a.getTypeOf(t);return c[r][e](t)},a.resolve=function(e){for(var t=e.split("/"),r=[],n=0;n<t.length;n++){var i=t[n];"."===i||""===i&&0!==n&&n!==t.length-1||(".."===i?r.pop():r.push(i))}return r.join("/")},a.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":o.nodebuffer&&r.isBuffer(e)?"nodebuffer":o.uint8array&&e instanceof Uint8Array?"uint8array":o.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(e){if(!o[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(e){var t,r,n="";for(r=0;r<(e||"").length;r++)n+="\\x"+((t=e.charCodeAt(r))<16?"0":"")+t.toString(16).toUpperCase();return n},a.delay=function(e,t,r){setImmediate(function(){e.apply(r||null,t||[])})},a.inherits=function(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r},a.extend=function(){var e,t,r={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&void 0===r[t]&&(r[t]=arguments[e][t]);return r},a.prepareContent=function(e,t,n,i,f){return u.Promise.resolve(t).then(function(e){var t="string"===a.getTypeOf(e);return t&&!i||blobSupport&&e instanceof Blob?e:o.nodebuffer&&(nodebufferSupport||!t)?r.newBufferFrom(e):void o.uint8array?t?h.decode(e):(Object.prototype.toString.call(e),e):"string"===a.getTypeOf(e)?h.decode(e):e})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./support"),f=e("./nodejsUtils"),s=e("./stream/GenericWorker"),a=e("./stream/StreamHelper"),o=e("./defaults"),h=e("./compressedObject"),u=e("./zipObject"),l=e("./generate"),c=e("./nodejsUtils"),d=e("./nodejs/NodejsStreamInputAdapter"),p=function(e,t,r){var n,i=n=e||t||r?new s("string"==typeof e||e instanceof String?"string":"nodebuffer"):null;return e?i=this._decodeBinaryString(e):t?i=this._decodeBase64(t):r&&(i=this._decodeUint8Array(r)),i};function m(){if(!(this instanceof m))return new m;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var e=new m;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}function _(e){return"[object RegExp]"===Object.prototype.toString.call(e)}m.prototype={loadAsync:function(e,t){var r=this;t=n.extend(t||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:function(e){return a.utf8decode(e)}});var s=null;if(t.base64&&(e=a.decode(e)),t.binary&&(e=a.string2binary(e)),"string"===n.getTypeOf(e))s=new p(e,t.binary?void 0:!0,!1);else if("nodebuffer"===n.getTypeOf(e))s=new p(e,void 0,!1);else if(t.base64&&"string"===n.getTypeOf(e)||!t.base64&&"string"==typeof e)s=new p(s,void 0,!0);var o=new u(null,s);return r.files[o.fileNameStr]=o,o},forEach:function(e){for(var t in this.files)this.files.hasOwnProperty(t)&&e.call(this,this.files[t],t)},filter:function(r){var n=[];return this.forEach(function(e,t){r.call(this,e,t)&&n.push(e)}),n},file:function(e,t,r){if(1!==arguments.length){if(e=this.root+e,m.prototype.file.call(this,e,t,r),this.files[e]){var n=this.files[e],i=n.fileNameStr;return delete n.fileNameStr,n.name=i,n}return null}if(_(e)){var s=e;return this.filter(function(e,t){return!e.dir&&s.test(t)})}var a=this.files[this.root+e];return a&&!a.dir?a:null},folder:function(r){if(!r)return this;if(_(r))return this.filter(function(e,t){return e.dir&&r.test(t)});var e=this.root+r,t=b.call(this,e),n=this.clone();return n.root=t.name,n},remove:function(r){r=this.root+r;var e=this.files[r];if(e||("/"!==r.slice(-1)&&(r+="/"),e=this.files[r]),e&&!e.dir)delete this.files[r];else for(var t=this.filter(function(e,t){return t.slice(0,r.length)===r}),n=0;n<t.length;n++)delete this.files[t[n].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,r={};try{if((r=n.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");n.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var s=r.comment||this.comment||"";t=l.generateWorker(this,r,s)}catch(e){(t=new i("error")).error(e)}return new a(t,r.type||"string",r.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}},t.exports=m},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./support":30,"./utils":32,"./zipObject":35}],34:[function(e,t,r){"use strict";t.exports=e("./nodejs/NodejsStreamOutputAdapter")},{"./nodejs/NodejsStreamOutputAdapter":13}],35:[function(e,t,r){"use strict";var n=e("./reader/readerFor"),i=e("./utils"),s=e("./compressedObject"),a=e("./crc32"),o=e("./utf8"),h=e("./compressions"),u=e("./support");function l(e,t){this.name=e,this.dir=t.dir,this.date=t.date,this.comment=t.comment,this.unixPermissions=t.unixPermissions,this.dosPermissions=t.dosPermissions,this._data=t._data,this._dataBinary=t._dataBinary,this.options={compression:t.compression,compressionOptions:t.compressionOptions}}var f=l.prototype={internalStream:function(e){var t=null,r="string";try{if(!e)throw new Error("No output type specified.");var n="string"===(r=e.toLowerCase())||"text"===r;"binarystring"!==r&&"text"!==r||(r="string"),t=this._decompressWorker();var i=!this._dataBinary;i&&!n&&(t=t.pipe(new o.Utf8EncodeWorker)),!i&&n&&(t=t.pipe(new o.Utf8DecodeWorker))}catch(e){(t=new s("error")).error(e)}return new a(t,r,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof s&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new o.Utf8EncodeWorker)),s.createWorkerFrom(r,e,t)},_decompressWorker:function(){return this._data instanceof s?this._data.getContentWorker():this._data instanceof n?this._data:new i(this._data)}};for(var c=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],d=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},p=0;p<c.length;p++)f[c[p]]=d;t.exports=l},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],36:[function(e,t,r){"use strict";var n=e("immediate");function h(){}var i={},s=["REJECTED"],a=["FULFILLED"],o=["PENDING"];if(t.exports=u,"undefined"!=typeof Promise){var l=Promise.resolve();c=function(){l.then(d)}}else if("function"==typeof setImmediate)c=function(){setImmediate(d)};else if("undefined"!=typeof n)c=function(){n(d)};else if("undefined"!=typeof setTimeout)c=function(){setTimeout(d,0)};else try{throw new Error("No async scheduler available")}catch(e){c=function(){throw new Error("No async scheduler available")}}var c;function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=o,this.queue=[],this.outcome=void 0,e!==h&&m(this,e)}function f(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function p(t,r,n){n(function(){var e;try{e=r(t)}catch(e){return i.reject(this,e)}e===this?i.reject(this,new TypeError("Cannot resolve promise with itself")):i.resolve(this,e)})}function m(t,e){var r=!1;function n(e){r||(r=!0,i.reject(t,e))}function s(e){r||(r=!0,i.resolve(t,e))}var a=_;try{e(function(e){a=h,s(e)},function(e){a=h,n(e)})}catch(e){a(),n(e)}}function _(){noop()}f.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},f.prototype.otherCallFulfilled=function(e){p(e,this.onFulfilled,this.callFulfilled)},f.prototype.callRejected=function(e){i.reject(this.promise,e)},f.prototype.otherCallRejected=function(e){p(e,this.onRejected,this.callRejected)},i.resolve=function(e,t){var r=_(t);if("error"===r.status)return i.reject(e,r.value);var n=r.value;if(n)m(e,n);else{e.state=a,e.outcome=t;for(var s=-1,o=e.queue.length;++s<o;)e.queue[s].callFulfilled(t)}return e},i.reject=function(e,t){e.state=s,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},u.resolve=function(e){if(e instanceof this)return e;return i.resolve(new this(h),e)},u.reject=function(e){return i.reject(new this(h),e)},u.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var s=new Array(r),a=0,o=-1,h=new this(h);++o<r;)i(e[o],o);return h;function i(e,o){t.resolve(e).then(function(e){s[o]=e,++a!==r||n||(n=!0,i.resolve(h,s))},function(e){n||(n=!0,i.reject(h,e))})}},u.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var s,a=-1,o=new this(h);++a<r;)s=e[a],t.resolve(s).then(function(e){n||(n=!0,i.resolve(o,e))},function(e){n||(n=!0,i.reject(o,e))});return o};var g={},b=("undefined"!=typeof global?global:"undefined"!=typeof window&&window||{}).Promise,v=u;if(b){var y=null;try{y=Object.prototype.toString.call(b.resolve())}catch(e){}if("[object Promise]"===y&&!b.cast)return}var w=!1;function d(){if(w)return;w=!0;for(var e,t=0;e=g[t++];)e();g=[]}u.Promise=v,u._setScheduler=function(e){c=e},u._setImmediateFn=function(e){d=e},u._asap=d},{"immediate":38}],37:[function(e,t,r){t.exports=e("./lib/promise")},{"./lib/promise":36}],38:[function(e,r,n){!function(e){var t=setTimeout;function n(){}function s(e){if(!(this instanceof s))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=undefined,this._deferreds=[],u(e,this)}function i(r,n){for(;3===r._state;)r=r._value;0!==r._state?(r._handled=!0,s._immediateFn(function(){var e=1===r._state?n.onFulfilled:n.onRejected;if(null!==e){var t;try{t=e(r._value)}catch(e){return void o(n.promise,e)}a(n.promise,t)}else(1===r._state?a:o)(n.promise,r._value)})):r._deferreds.push(n)}function a(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if(e instanceof s)return t._state=3,t._value=e,void h(t);if("function"==typeof r)return void u((n=r,i=e,function(){n.apply(i,arguments)}),t)}t._state=1,t._value=e,h(t)}catch(e){o(t,e)}var n,i}function o(e,t){e._state=2,e._value=t,h(e)}function h(e){2===e._state&&0===e._deferreds.length&&s._immediateFn(function(){e._handled||s._unhandledRejectionFn(e._value)});for(var t=0,r=e._deferreds.length;t<r;t++)i(e,e._deferreds[t]);e._deferreds=null}function u(e,t){var r=!1;try{e(function(e){r||(r=!0,a(t,e))},function(e){r||(r=!0,o(t,e))})}catch(e){if(r)return;r=!0,o(t,e)}}s.prototype.catch=function(e){return this.then(null,e)},s.prototype.then=function(e,t){var r=new this.constructor(n);return i(this,new function(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}(e,t,r)),r},s.prototype.finally=function(t){var r=this.constructor;return this.then(function(e){return r.resolve(t()).then(function(){return e})},function(e){return r.resolve(t()).then(function(){return r.reject(e)})})},s.all=function(e){return new s(function(n,i){if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var s=Array.prototype.slice.call(e);if(0===s.length)return n([]);var a=s.length;function o(t,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if("function"==typeof r)return void r.call(e,function(e){o(t,e)},i)}s[t]=e,0==--a&&n(s)}catch(e){i(e)}}for(var t=0;t<s.length;t++)o(t,s[t])})},s.resolve=function(t){return t&&"object"==typeof t&&t.constructor===s?t:new s(function(e){e(t)})},s.reject=function(r){return new s(function(e,t){t(r)})},s.race=function(i){return new s(function(e,t){for(var r=0,n=i.length;r<n;r++)i[r].then(e,t)})},s._immediateFn="function"==typeof t?function(e){t(e)}:function(e){setTimeout(e,0)},s._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},r.exports&&(r.exports=s)}(n)},{}],39:[function(e,t,r){"use strict";t.exports=e("./dist/jszip")},{"./dist/jszip":10}],54:[function(e,o,t){!function(e,t){var r=0,n="",i="",s=function(e,t){return setTimeout(function(){e()},t)},a=t.MutationObserver||t.WebKitMutationObserver;if(a){var h=0,u=document.createTextNode("");new a(e).observe(u,{characterData:!0}),n=function(){u.data=h=++h%2}}else if(t.postMessage&&!t.ActiveXObject&&t.addEventListener){var l=!0,c=t.onmessage;t.onmessage=function(){l=!1},t.postMessage("","*"),t.onmessage=c,l&&(i="postMessage",n=function(){t.postMessage("setImmediate","*")},t.addEventListener("message",function(e){"setImmediate"===e.data&&e.source===t&&e()},!1))}else n="setTimeout";o.exports=function(){var e=[].slice.call(arguments),t=e.shift();if("function"!=typeof t)throw new TypeError("Argument 0 must be a function");var n={fn:t,args:e};function i(){n.fn.apply(null,n.args)}return"postMessage"===i?t.post(0,i):++r,s(i,0),r}}(this,self)},{}]},{},[39])(39)});
</script>

<script>
// 内存存储 - 替代 localStorage 用于沙箱环境
const memoryStorage = {
  _data: {},
  setItem: function(key, value) {
    this._data[key] = value;
  },
  getItem: function(key) {
    return this._data[key] || null;
  },
  removeItem: function(key) {
    delete this._data[key];
  },
  clear: function() {
    this._data = {};
  }
};

// 存储功能封装，适应不同环境
const storage = {
  mode: 'memory', // 默认使用内存模式
  
  setItem: function(key, value) {
    try {
      if (this.mode === 'localStorage') {
        localStorage.setItem(key, value);
      } else {
        memoryStorage.setItem(key, value);
      }
    } catch (e) {
      console.error("存储失败，回退到内存模式:", e);
      this.mode = 'memory';
      memoryStorage.setItem(key, value);
    }
  },
  
  getItem: function(key) {
    try {
      if (this.mode === 'localStorage') {
        return localStorage.getItem(key);
      } else {
        return memoryStorage.getItem(key);
      }
    } catch (e) {
      console.error("读取失败，回退到内存模式:", e);
      this.mode = 'memory';
      return memoryStorage.getItem(key);
    }
  },
  
  removeItem: function(key) {
    try {
      if (this.mode === 'localStorage') {
        localStorage.removeItem(key);
      } else {
        memoryStorage.removeItem(key);
      }
    } catch (e) {
      console.error("删除失败:", e);
    }
  },
  
  // 检测存储模式是否可用
  detectAvailableMode: function() {
    try {
      localStorage.setItem('_test', '1');
      localStorage.removeItem('_test');
      this.mode = 'localStorage';
      return 'localStorage';
    } catch (e) {
      this.mode = 'memory';
      return 'memory';
    }
  }
};

// 全局变量
let currentAudioBlob = null;
let customVoices = []; // 用户克隆的音色列表
let systemVoices = []; // 系统可用的克隆音色列表

// 批量处理相关变量
let batchTextItems = []; // 批量处理的文本项
let batchResults = []; // 批量处理结果
let isProcessingBatch = false; // 是否正在批量处理
let stopBatchFlag = false; // 停止批量处理的标志
let batchCurrentIndex = 0; // 当前处理的索引
let batchZipContent = null; // 批量生成的ZIP文件内容

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  // 检测可用的存储模式
  const availableMode = storage.detectAvailableMode();
  logMessage(`当前使用${availableMode === 'localStorage' ? 'LocalStorage' : '内存'}存储模式`, "info");
  
  // 加载用户自定义音色
  loadCustomVoices();
  
  // 添加音色下拉菜单变化监听器
  const voiceDropdown = document.getElementById('voiceId');
  voiceDropdown.addEventListener('change', function() {
    const selectedVoice = this.value;
    logMessage(`已选择音色: ${selectedVoice}`, "info");
    
    // 高亮显示当前选中的选项
    for (let i = 0; i < this.options.length; i++) {
      if (this.options[i].value === selectedVoice) {
        if (this.options[i].textContent.includes('克隆音色')) {
          logMessage(`当前使用的是克隆音色: ${selectedVoice}`, "info");
        }
      }
    }
  });
  
  // 记录初始化完成
  logMessage("系统初始化完成", "info");
  logMessage("准备就绪，请设置参数并输入文本", "info");
});

// 处理批量文件选择
function handleBatchFileSelect(input) {
  if (!input.files || input.files.length === 0) {
    document.getElementById('batchFileName').textContent = '未选择文件';
    document.getElementById('startBatchBtn').disabled = true;
    return;
  }
  
  const file = input.files[0];
  document.getElementById('batchFileName').textContent = file.name;
  
  // 检查文件类型
  if (file.type !== 'text/plain' && !file.name.toLowerCase().endsWith('.txt')) {
    logMessage("请选择正确的TXT文本文件", "error");
    document.getElementById('startBatchBtn').disabled = true;
    return;
  }
  
  // 读取文件内容
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    
    // 按行分割
    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
    
    if (lines.length === 0) {
      logMessage("文件内容为空", "error");
      document.getElementById('startBatchBtn').disabled = true;
      return;
    }
    
    logMessage(`成功读取文本文件，共 ${lines.length} 行`, "success");
    batchTextItems = lines;
    document.getElementById('startBatchBtn').disabled = false;
  };
  
  reader.onerror = function() {
    logMessage("读取文件失败", "error");
    document.getElementById('startBatchBtn').disabled = true;
  };
  
  reader.readAsText(file);
}

// 开始批量处理
function startBatchProcess() {
  if (isProcessingBatch) {
    logMessage("批量处理已在进行中", "warning");
    return;
  }
  
  if (batchTextItems.length === 0) {
    logMessage("没有可处理的文本行", "error");
    return;
  }
  
  // 准备批量处理
  isProcessingBatch = true;
  stopBatchFlag = false;
  batchCurrentIndex = 0;
  batchResults = [];
  batchZipContent = new JSZip();
  
  // 显示进度容器
  document.getElementById('batchContainer').style.display = 'block';
  document.getElementById('batchDownloadDiv').style.display = 'none';
  document.getElementById('batchResults').innerHTML = '';
  
  // 更新按钮状态
  document.getElementById('startBatchBtn').disabled = true;
  document.getElementById('stopBatchBtn').disabled = false;
  
  // 更新进度显示
  updateBatchProgress(0, batchTextItems.length);
  
  // 启动批量处理
  logMessage(`开始批量处理 ${batchTextItems.length} 条文本`, "info");
  
  // 获取并发数量
  const concurrency = parseInt(document.getElementById('batchConcurrency').value) || 3;
  processBatchWithConcurrency(concurrency);
}

// 使用并发控制批量处理
function processBatchWithConcurrency(concurrency) {
  // 获取共享的语音生成参数
  const sharedParams = getBatchGenerationParams();
  
  // 跟踪活跃的任务数
  let activeTasks = 0;
  let completedTasks = 0;
  const totalTasks = batchTextItems.length;
  
  // 用于处理单个任务的函数
  function processTask(index) {
    if (index >= totalTasks || stopBatchFlag) {
      // 所有任务完成或已停止
      if (activeTasks === 0 && !stopBatchFlag) {
        finishBatchProcess();
      }
      return;
    }
    
    activeTasks++;
    const text = batchTextItems[index];
    
    // 使用序号和文本内容生成文件名
    // 保留文本内容的前30个字符，避免文件名过长
    const sanitizedText = text.substring(0, 30).replace(/[\\/:*?"<>|]/g, '_');
    const fileName = `${index+1}_${sanitizedText}`;
    
    // 记录开始处理
    logBatchItem(index, text, 'processing');
    
    // 生成语音
    generateSpeechForBatch(text, sharedParams)
      .then(audioBlob => {
        // 成功生成
        const textContent = text;
        
        // 将文本和音频添加到ZIP (都放在根目录)
        const textFileName = `${fileName}.txt`;
        const audioFileName = `${fileName}.${sharedParams.format || 'mp3'}`;
        
        batchZipContent.file(textFileName, textContent);
        batchZipContent.file(audioFileName, audioBlob);
        
        // 记录结果
        batchResults.push({
          index: index,
          text: text,
          textFile: textFileName,
          audioFile: audioFileName,
          success: true
        });
        
        logBatchItem(index, text, 'success');
      })
      .catch(error => {
        // 生成失败
        logBatchItem(index, text, 'error', error.message);
        
        // 记录失败结果
        batchResults.push({
          index: index,
          text: text,
          success: false,
          error: error.message
        });
      })
      .finally(() => {
        activeTasks--;
        completedTasks++;
        
        // 更新进度
        updateBatchProgress(completedTasks, totalTasks);
        
        // 检查是否还有更多任务可以启动
        if (!stopBatchFlag) {
          // 启动下一个任务
          processTask(batchCurrentIndex++);
        }
        
        // 如果没有活跃任务，且所有任务已启动，则完成处理
        if (activeTasks === 0 && batchCurrentIndex >= totalTasks) {
          finishBatchProcess();
        }
      });
  }
  
  // 初始启动concurrency个任务
  for (let i = 0; i < concurrency && i < totalTasks; i++) {
    processTask(batchCurrentIndex++);
  }
}

// 获取批量生成的参数
function getBatchGenerationParams() {
  return {
    model: document.getElementById('model').value,
    voiceId: document.getElementById('voiceId').value,
    speed: parseFloat(document.getElementById('speed').value),
    vol: parseFloat(document.getElementById('vol').value),
    pitch: parseInt(document.getElementById('pitch').value),
    emotion: document.getElementById('emotion').value,
    format: document.getElementById('outputFormat').value,
    latexRead: document.getElementById('latexRead').checked,
    englishNormalization: document.getElementById('englishNormalization').checked,
    apiKey: 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLoi4_mmI4iLCJVc2VyTmFtZSI6IuiLj-aYjiIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxOTEyNjc4NjAwODM5MDEyOTY1IiwiUGhvbmUiOiIxNTExNjkwNTA2MiIsIkdyb3VwSUQiOiIxOTEyNjc4NjAwODMwNjI0MzU3IiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMDQtMTkgMTE6MDQ6MzMiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.V_YhYLmgyfnAV3ssptSqTKHiUjuqbQq62FZBCsRJgtUobIMCJuZYtxHuBtOcJot6VeKLjUXZtECPrjqGTR6MfViYujZC-HdXcUxUtVW3Z59_hHr2UWVnLUGLl0CQoiM0-QtEOa2KL3-VCo7iffhSnusNiYX9LF44iefN0AOEdKuMlmj8NejFPCamusQ1soCwIto2dT3oCkPSm8IOPWs4qej_jgc07yGRiZVFIfBOFO8opiWrzu9z43KGACQsbAAzdxLFKbm3P_uwSjrVNTBxOI8FXGXYBBR3zIOJT-9rwtRq-k9CnITKyo4_YyAmmD29ps_Q6etakd1KJBFfgZN5Bg',
    groupId: '1912678600830624357',
    apiEndpoint: 'https://api.minimax.chat/v1/t2a_v2'
  };
}

// 为批量处理生成单个语音
function generateSpeechForBatch(text, params) {
  return new Promise((resolve, reject) => {
    try {
      // 准备请求数据
      const requestData = {
        model: params.model,
        text: text,
        stream: false,
        voice_setting: {
          voice_id: params.voiceId,
          speed: params.speed,
          vol: params.vol,
          pitch: params.pitch
        },
        audio_setting: {
          sample_rate: 32000,
          bitrate: 128000,
          format: params.format,
          channel: 1
        }
      };
      
      // 添加可选参数
      if (params.emotion) {
        requestData.voice_setting.emotion = params.emotion;
      }
      
      if (params.latexRead) {
        requestData.latex_read = true;
      }
      
      if (params.englishNormalization) {
        requestData.english_normalization = true;
      }
      
      // 构建请求URL
      const apiUrl = `${params.apiEndpoint}?GroupId=${params.groupId}`;
      
      // 使用XMLHttpRequest发送请求
      const xhr = new XMLHttpRequest();
      xhr.open('POST', apiUrl, true); // 异步请求
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Authorization', `Bearer ${params.apiKey}`);
      xhr.responseType = 'text'; // 确保以文本方式接收
      
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            
            // 检查API响应
            if (response.base_resp && response.base_resp.status_code !== 0) {
              reject(new Error(`API返回错误: ${response.base_resp.status_msg}`));
              return;
            }
            
            if (!response.data || !response.data.audio) {
              reject(new Error("API响应中未找到音频数据"));
              return;
            }
            
            // 处理音频数据
            const audioHex = response.data.audio;
            
            // 转换十六进制为ArrayBuffer
            const audioBytes = hexToArrayBuffer(audioHex);
            const audioBlob = new Blob([audioBytes], { type: `audio/${params.format}` });
            
            // 如果使用的是克隆音色，更新克隆音色的使用时间
            if (isCustomVoice(params.voiceId)) {
              updateCustomVoiceUsage(params.voiceId);
            }
            
            resolve(audioBlob);
          } catch (e) {
            reject(new Error(`JSON解析错误: ${e.message}`));
          }
        } else {
          const errorText = xhr.responseText || '无响应数据';
          reject(new Error(`HTTP错误: ${xhr.status} - ${errorText.substring(0, 100)}`));
        }
      };
      
      xhr.onerror = function() {
        reject(new Error("网络错误，请求失败"));
      };
      
      xhr.ontimeout = function() {
        reject(new Error("请求超时"));
      };
      
      // 设置超时（10秒）
      xhr.timeout = 10000;
      
      // 发送请求
      xhr.send(JSON.stringify(requestData));
    } catch (error) {
      reject(new Error(`请求准备失败: ${error.message}`));
    }
  });
}

// 更新批量处理进度
function updateBatchProgress(current, total) {
  const percentage = Math.floor((current / total) * 100);
  document.getElementById('batchProgressBar').style.width = `${percentage}%`;
  document.getElementById('batchProgressText').textContent = `进度: ${percentage}%`;
  document.getElementById('batchCountText').textContent = `${current}/${total}`;
}

// 记录批量处理项目
function logBatchItem(index, text, status, errorMsg = '') {
  // 在界面上创建/更新记录
  const itemId = `batch-item-${index}`;
  let itemElement = document.getElementById(itemId);
  
  if (!itemElement) {
    // 创建新元素
    itemElement = document.createElement('div');
    itemElement.id = itemId;
    itemElement.className = 'batch-item';
    document.getElementById('batchResults').appendChild(itemElement);
  }
  
  // 更新元素内容和样式
  if (status === 'processing') {
    itemElement.innerHTML = `<span>[${index+1}] 处理中: ${text.substring(0, 40)}${text.length > 40 ? '...' : ''}</span>`;
    itemElement.className = 'batch-item';
  } else if (status === 'success') {
    itemElement.innerHTML = `<span>[${index+1}] 成功: ${text.substring(0, 40)}${text.length > 40 ? '...' : ''}</span>`;
    itemElement.className = 'batch-item success';
  } else if (status === 'error') {
    itemElement.innerHTML = `<span>[${index+1}] 失败: ${text.substring(0, 40)}${text.length > 40 ? '...' : ''}</span><span title="${errorMsg}">错误</span>`;
    itemElement.className = 'batch-item error';
  }
  
  // 滚动到底部
  const resultsContainer = document.getElementById('batchResults');
  resultsContainer.scrollTop = resultsContainer.scrollHeight;
}

// 停止批量处理
function stopBatchProcess() {
  if (!isProcessingBatch) return;
  
  stopBatchFlag = true;
  logMessage("正在停止批量处理...", "warning");
  document.getElementById('stopBatchBtn').disabled = true;
  
  // 等待所有进行中的任务完成
  setTimeout(() => {
    finishBatchProcess(true);
  }, 1000);
}

// 完成批量处理
function finishBatchProcess(stopped = false) {
  isProcessingBatch = false;
  
  // 更新按钮状态
  document.getElementById('startBatchBtn').disabled = false;
  document.getElementById('stopBatchBtn').disabled = true;
  
  // 统计成功和失败数量
  const successCount = batchResults.filter(r => r.success).length;
  const failCount = batchResults.filter(r => !r.success).length;
  
  if (stopped) {
    logMessage(`批量处理已停止。成功: ${successCount}, 失败: ${failCount}`, "warning");
  } else {
    logMessage(`批量处理完成。成功: ${successCount}, 失败: ${failCount}`, "success");
  }
  
  // 如果有成功的结果，显示下载按钮
  if (successCount > 0) {
    document.getElementById('batchDownloadDiv').style.display = 'block';
  }
}

// 下载批量处理结果
function downloadBatchResults() {
  if (!batchZipContent || batchResults.length === 0) {
    logMessage("没有可下载的结果", "error");
    return;
  }
  
  const folderName = document.getElementById('outputFolder').value || 'tts_output';
  
  // 添加一个README文件
  const successCount = batchResults.filter(r => r.success).length;
  const failCount = batchResults.filter(r => !r.success).length;
  
  const readmeContent = `# 语音生成批量处理结果

处理时间: ${new Date().toLocaleString()}
总记录数: ${batchResults.length}
成功数: ${successCount}
失败数: ${failCount}

## 结果列表
${batchResults.map((item, idx) => {
    if (item.success) {
      return `${idx+1}. [成功] "${item.text.substring(0, 50)}${item.text.length > 50 ? '...' : ''}"\n   - 文本文件: ${item.textFile}\n   - 音频文件: ${item.audioFile}`;
    } else {
      return `${idx+1}. [失败] "${item.text.substring(0, 50)}${item.text.length > 50 ? '...' : ''}" - 错误: ${item.error}`;
    }
  }).join('\n\n')}
`;
  
  batchZipContent.file("README.md", readmeContent);
  
  // 生成并下载ZIP文件
  batchZipContent.generateAsync({type: "blob"})
    .then(function(content) {
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${folderName}_${new Date().toISOString().replace(/[:.]/g, '-')}.zip`;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      logMessage(`ZIP文件下载已开始: ${a.download}`, "success");
    })
    .catch(error => {
      logMessage(`生成ZIP文件出错: ${error.message}`, "error");
    });
}

// 更新滑块值
function updateSliderValue(sliderId, valueId) {
  const slider = document.getElementById(sliderId);
  const valueElement = document.getElementById(valueId);
  valueElement.textContent = slider.value;
}

// 验证音色ID
function validateVoiceId() {
  const voiceIdInput = document.getElementById('customVoiceId');
  const voiceId = voiceIdInput.value;
  
  // 检查长度
  const lengthValid = voiceId.length >= 8 && voiceId.length <= 256;
  document.getElementById('validLength').className = 
    `validation-item ${lengthValid ? 'pass' : 'fail'}`;
  
  // 检查首字符
  const startValid = /^[a-zA-Z]/.test(voiceId);
  document.getElementById('validStart').className = 
    `validation-item ${startValid ? 'pass' : 'fail'}`;
  
  // 检查字符
  const charsValid = /^[a-zA-Z0-9_\-]*$/.test(voiceId);
  document.getElementById('validChars').className = 
    `validation-item ${charsValid ? 'pass' : 'fail'}`;
  
  // 检查末尾字符
  const endValid = !voiceId.endsWith('-') && !voiceId.endsWith('_');
  document.getElementById('validEnd').className = 
    `validation-item ${endValid ? 'pass' : 'fail'}`;
  
  return lengthValid && startValid && charsValid && endValid;
}

// 验证音频文件
function validateAudioFile(inputElement, fileNameId) {
  if (!inputElement.files || inputElement.files.length === 0) {
    document.getElementById(fileNameId).textContent = '未选择文件';
    return false;
  }
  
  const file = inputElement.files[0];
  document.getElementById(fileNameId).textContent = file.name;
  
  // 检查文件格式
  const validFormats = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/x-m4a'];
  const fileExt = file.name.split('.').pop().toLowerCase();
  const validExt = ['mp3', 'wav', 'm4a'].includes(fileExt);
  
  // 检查文件大小
  const maxSize = 20 * 1024 * 1024; // 20MB
  const validSize = file.size <= maxSize;
  
  let errorMsg = '';
  
  if (!validExt && !validFormats.includes(file.type)) {
    errorMsg = `不支持的文件格式: ${file.type || fileExt}。请使用 MP3、WAV 或 M4A 格式`;
  } else if (!validSize) {
    errorMsg = `文件过大: ${(file.size / (1024 * 1024)).toFixed(2)}MB。最大支持20MB`;
  }
  
  if (errorMsg) {
    const validationDiv = document.getElementById('audioFileValidation');
    if (validationDiv) {
      validationDiv.textContent = errorMsg;
      validationDiv.className = "validation-item fail";
    }
    return false;
  }
  
  document.getElementById('audioFileValidation').textContent = '';
  return true;
}

// 开始音色克隆
function startVoiceClone() {
  // 获取按钮引用并显示加载状态
  const cloneBtn = document.getElementById('startCloneBtn');
  const originalBtnText = cloneBtn.textContent;
  
  // 显示加载状态
  cloneBtn.innerHTML = '<span class="spinner"></span>克隆中...';
  cloneBtn.disabled = true;
  
  // 记录日志
  logMessage("开始音色克隆过程...", "info");
  
  // 获取必要的输入值
  const customVoiceId = document.getElementById('customVoiceId').value.trim();
  
  // 基本验证
  if (!customVoiceId) {
    logMessage("请输入自定义音色ID", "error");
    cloneBtn.textContent = originalBtnText;
    cloneBtn.disabled = false;
    return;
  }
  
  // 确保有文件被选择
  const cloneFileInput = document.getElementById('cloneAudioFile');
  if (!cloneFileInput.files || cloneFileInput.files.length === 0) {
    logMessage("请选择音频文件", "error");
    cloneBtn.textContent = originalBtnText;
    cloneBtn.disabled = false;
    return;
  }
  
  // 验证音色ID
  if (!validateVoiceId()) {
    logMessage("无效的音色ID格式", "error");
    cloneBtn.textContent = originalBtnText;
    cloneBtn.disabled = false;
    return;
  }
  
  // 验证音频文件
  if (!validateAudioFile(cloneFileInput, 'cloneFileName')) {
    logMessage("音频文件验证失败", "error");
    cloneBtn.textContent = originalBtnText;
    cloneBtn.disabled = false;
    return;
  }
  
  // 上传主音频文件
  logMessage("开始上传主音频文件...", "info");
  const audioFile = cloneFileInput.files[0];
  
  uploadFile(audioFile)
    .then(fileId => {
      logMessage(`主音频上传成功, fileId: ${fileId}`, "success");
      
      // 准备请求数据
      const requestData = {
        file_id: fileId,
        voice_id: customVoiceId,
        accuracy: 0.7,
        need_noise_reduction: false,
        need_volume_normalization: false,
        text: "这是一段使用克隆音色的试听音频",
        model: "speech-02-turbo"
      };
      
      // 发送克隆请求
      logMessage("发送音色克隆请求...", "info");
      
      const apiKey = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLoi4_mmI4iLCJVc2VyTmFtZSI6IuiLj-aYjiIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxOTEyNjc4NjAwODM5MDEyOTY1IiwiUGhvbmUiOiIxNTExNjkwNTA2MiIsIkdyb3VwSUQiOiIxOTEyNjc4NjAwODMwNjI0MzU3IiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMDQtMTkgMTE6MDQ6MzMiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.V_YhYLmgyfnAV3ssptSqTKHiUjuqbQq62FZBCsRJgtUobIMCJuZYtxHuBtOcJot6VeKLjUXZtECPrjqGTR6MfViYujZC-HdXcUxUtVW3Z59_hHr2UWVnLUGLl0CQoiM0-QtEOa2KL3-VCo7iffhSnusNiYX9LF44iefN0AOEdKuMlmj8NejFPCamusQ1soCwIto2dT3oCkPSm8IOPWs4qej_jgc07yGRiZVFIfBOFO8opiWrzu9z43KGACQsbAAzdxLFKbm3P_uwSjrVNTBxOI8FXGXYBBR3zIOJT-9rwtRq-k9CnITKyo4_YyAmmD29ps_Q6etakd1KJBFfgZN5Bg';
      const groupId = '1912678600830624357';
      
      const baseUrl = 'https://api.minimax.chat/v1/voice_clone';
      const fullUrl = `${baseUrl}?GroupId=${groupId}`;
      
      const xhr = new XMLHttpRequest();
      xhr.open('POST', fullUrl, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
      xhr.responseType = 'json';
      
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          const response = xhr.response;
          
          if (response.base_resp && response.base_resp.status_code === 0) {
            logMessage(`音色克隆成功: ${customVoiceId}`, "success");
            
            // 添加到自定义音色列表
            addCustomVoice(customVoiceId);
            
          } else {
            const errorMsg = response.base_resp?.status_msg || "未知错误";
            const errorCode = response.base_resp?.status_code || "未知错误码";
            logMessage(`API错误 (${errorCode}): ${errorMsg}`, "error");
          }
        } else {
          let errorMessage = `HTTP错误: ${xhr.status}`;
          try {
            const errorResponse = xhr.response;
            if (errorResponse.base_resp && errorResponse.base_resp.status_msg) {
              errorMessage += ` - ${errorResponse.base_resp.status_msg}`;
            }
          } catch (e) {}
          logMessage(errorMessage, "error");
        }
        
        // 恢复按钮状态
        cloneBtn.textContent = originalBtnText;
        cloneBtn.disabled = false;
      };
      
      xhr.onerror = function() {
        logMessage("网络错误，请求失败", "error");
        cloneBtn.textContent = originalBtnText;
        cloneBtn.disabled = false;
      };
      
      xhr.ontimeout = function() {
        logMessage("请求超时", "error");
        cloneBtn.textContent = originalBtnText;
        cloneBtn.disabled = false;
      };
      
      // 设置超时时间
      xhr.timeout = 30000; // 30秒
      
      // 发送请求
      xhr.send(JSON.stringify(requestData));
    })
    .catch(error => {
      logMessage(`上传音频文件失败: ${error.message}`, "error");
      cloneBtn.textContent = originalBtnText;
      cloneBtn.disabled = false;
    });
}

// 上传文件
function uploadFile(file) {
  return new Promise((resolve, reject) => {
    try {
      const apiKey = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLoi4_mmI4iLCJVc2VyTmFtZSI6IuiLj-aYjiIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxOTEyNjc4NjAwODM5MDEyOTY1IiwiUGhvbmUiOiIxNTExNjkwNTA2MiIsIkdyb3VwSUQiOiIxOTEyNjc4NjAwODMwNjI0MzU3IiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMDQtMTkgMTE6MDQ6MzMiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.V_YhYLmgyfnAV3ssptSqTKHiUjuqbQq62FZBCsRJgtUobIMCJuZYtxHuBtOcJot6VeKLjUXZtECPrjqGTR6MfViYujZC-HdXcUxUtVW3Z59_hHr2UWVnLUGLl0CQoiM0-QtEOa2KL3-VCo7iffhSnusNiYX9LF44iefN0AOEdKuMlmj8NejFPCamusQ1soCwIto2dT3oCkPSm8IOPWs4qej_jgc07yGRiZVFIfBOFO8opiWrzu9z43KGACQsbAAzdxLFKbm3P_uwSjrVNTBxOI8FXGXYBBR3zIOJT-9rwtRq-k9CnITKyo4_YyAmmD29ps_Q6etakd1KJBFfgZN5Bg';
      const groupId = '1912678600830624357';
      
      // 构建FormData
      const formData = new FormData();
      formData.append('purpose', 'voice_clone');
      formData.append('file', file);
      
      const baseUrl = 'https://api.minimax.chat/v1/files/upload';
      const fullUrl = `${baseUrl}?GroupId=${groupId}`;
      
      logMessage(`尝试上传文件到: ${fullUrl}`, "info");
      
      const xhr = new XMLHttpRequest();
      xhr.open('POST', fullUrl, true);
      xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
      
      // 添加超时处理
      xhr.timeout = 30000; // 30秒超时
      
      xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const response = JSON.parse(xhr.responseText);
            
            if (response.file && response.file.file_id) {
              logMessage(`文件上传成功，获取到fileId: ${response.file.file_id}`, "success");
              resolve(response.file.file_id);
            } else {
              logMessage(`无效的上传响应: ${xhr.responseText}`, "error");
              reject(new Error("上传响应中未找到file_id"));
            }
          } catch (e) {
            logMessage(`JSON解析错误: ${e.message}, 原始响应: ${xhr.responseText}`, "error");
            reject(new Error(`JSON解析错误: ${e.message}`));
          }
        } else {
          let errorMessage = `HTTP错误: ${xhr.status}`;
          try {
            const errorResp = JSON.parse(xhr.responseText);
            if (errorResp.base_resp && errorResp.base_resp.status_msg) {
              errorMessage += ` - ${errorResp.base_resp.status_msg}`;
            }
          } catch (e) {}
          
          logMessage(errorMessage, "error");
          reject(new Error(errorMessage));
        }
      };
      
      xhr.onerror = function() {
        logMessage("上传请求失败，网络错误", "error");
        reject(new Error("上传失败，网络错误"));
      };
      
      xhr.ontimeout = function() {
        logMessage("上传请求超时", "error");
        reject(new Error("上传请求超时"));
      };
      
      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          logMessage(`上传进度: ${percent}%`, "info");
        }
      };
      
      // 发送请求
      xhr.send(formData);
    } catch (error) {
      logMessage(`文件上传准备错误: ${error.message}`, "error");
      reject(error);
    }
  });
}

// 添加自定义音色
function addCustomVoice(voiceId) {
  // 创建新的自定义音色对象
  const newVoice = {
    id: voiceId,
    createdAt: new Date().toISOString(),
    lastUsed: new Date().toISOString()
  };
  
  // 检查是否已存在
  const existingIndex = customVoices.findIndex(v => v.id === voiceId);
  if (existingIndex >= 0) {
    customVoices[existingIndex].lastUsed = newVoice.lastUsed;
  } else {
    // 添加到列表
    customVoices.push(newVoice);
    
    // 添加到下拉菜单
    addVoiceToDropdown(newVoice);
  }
  
  // 保存到存储
  saveCustomVoices();
  
  // 更新自定义音色列表显示
  updateCustomVoiceListUI();
}

// 添加音色到下拉菜单
function addVoiceToDropdown(voice) {
  const dropdown = document.getElementById('voiceId');
  
  // 检查是否已存在
  for (let i = 0; i < dropdown.options.length; i++) {
    if (dropdown.options[i].value === voice.id) {
      return; // 已存在，不重复添加
    }
  }
  
  // 创建新选项
  const option = document.createElement('option');
  option.value = voice.id;
  option.textContent = `${voice.id}（克隆音色）`;
  option.style.color = '#4285f4';
  option.style.fontWeight = 'bold';
  
  // 添加到下拉菜单顶部而不是底部
  if (dropdown.firstChild) {
    dropdown.insertBefore(option, dropdown.firstChild);
  } else {
    dropdown.appendChild(option);
  }
  
  // 自动选择新添加的音色
  dropdown.value = voice.id;
}

// 更新自定义音色使用时间
function updateCustomVoiceUsage(voiceId) {
  const voiceIndex = customVoices.findIndex(v => v.id === voiceId);
  if (voiceIndex !== -1) {
    customVoices[voiceIndex].lastUsed = new Date().toISOString();
    saveCustomVoices();
    updateCustomVoiceListUI();
    logMessage(`更新了音色 ${voiceId} 的使用时间，此音色已永久保存`, "info");
  }
}

// 检查是否是自定义音色
function isCustomVoice(voiceId) {
  return customVoices.some(v => v.id === voiceId);
}

// 保存自定义音色列表
function saveCustomVoices() {
  try {
    storage.setItem('minimax_custom_voices', JSON.stringify(customVoices));
  } catch (error) {
    console.error("保存自定义音色失败:", error);
  }
}

// 加载自定义音色列表
function loadCustomVoices() {
  try {
    const savedVoices = storage.getItem('minimax_custom_voices');
    if (savedVoices) {
      customVoices = JSON.parse(savedVoices);
      
      // 添加到下拉菜单
      customVoices.forEach(voice => {
        addVoiceToDropdown(voice);
      });
      
      // 更新自定义音色列表显示
      updateCustomVoiceListUI();
    }
  } catch (error) {
    console.error("加载自定义音色失败:", error);
    customVoices = [];
  }
}

// 更新自定义音色列表UI
function updateCustomVoiceListUI() {
  const listContainer = document.getElementById('customVoiceList');
  
  // 清空列表
  listContainer.innerHTML = '';
  
  if (customVoices.length === 0) {
    listContainer.innerHTML = '<div class="log-entry log-info">暂无克隆音色，请使用上方表单创建。</div>';
    return;
  }
  
  // 按最后使用时间排序（最新的在前面）
  const sortedVoices = [...customVoices].sort((a, b) =>
    new Date(b.lastUsed) - new Date(a.lastUsed)
  );
  
  // 添加每个音色项
  sortedVoices.forEach(voice => {
    const voiceItem = document.createElement('div');
    voiceItem.className = 'custom-voice-item';
    
    // 计算过期时间（7天后）
    const createdDate = new Date(voice.createdAt);
    const expireDate = new Date(createdDate);
    expireDate.setDate(expireDate.getDate() + 7);
    
    // 检查是否已使用（永久保存）
    const lastUsedDate = new Date(voice.lastUsed);
    const isUsed = lastUsedDate > createdDate;
    
    // 检查是否过期
    const now = new Date();
    const isExpired = !isUsed && now > expireDate;
    
    // 创建元素
    const nameEl = document.createElement('div');
    nameEl.className = 'custom-voice-name';
    nameEl.textContent = voice.id;
    
    const dateEl = document.createElement('div');
    dateEl.className = 'custom-voice-date';
    
    if (isUsed) {
      dateEl.textContent = `已永久保存，最后使用: ${formatDate(lastUsedDate)}`;
    } else if (isExpired) {
      dateEl.textContent = `已过期，创建于: ${formatDate(createdDate)}`;
      dateEl.style.color = '#dc3545';
    } else {
      const daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
      dateEl.textContent = `将在${daysLeft}天后过期，创建于: ${formatDate(createdDate)}`;
      dateEl.style.color = '#ffc107';
    }
    
    const controlsEl = document.createElement('div');
    controlsEl.className = 'custom-voice-controls';
    
    const useBtn = document.createElement('button');
    useBtn.className = 'success-btn';
    useBtn.textContent = '使用';
    useBtn.onclick = function() {
      // 选中该音色
      document.getElementById('voiceId').value = voice.id;
      logMessage(`已选择克隆音色: ${voice.id}`, "info");
      
      // 滚动到页面顶部
      window.scrollTo(0, 0);
    };
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'danger-btn';
    deleteBtn.textContent = '删除';
    deleteBtn.onclick = function() {
      deleteCustomVoice(voice.id);
    };
    
    // 组装元素
    controlsEl.appendChild(useBtn);
    controlsEl.appendChild(deleteBtn);
    
    voiceItem.appendChild(nameEl);
    voiceItem.appendChild(dateEl);
    voiceItem.appendChild(controlsEl);
    
    // 如果已过期，添加样式
    if (isExpired) {
      voiceItem.style.opacity = '0.6';
    }
    
    listContainer.appendChild(voiceItem);
  });
}

// 删除自定义音色
function deleteCustomVoice(voiceId) {
  if (confirm(`确定要删除音色"${voiceId}"吗？此操作无法撤销。`)) {
    // 从列表中删除
    customVoices = customVoices.filter(voice => voice.id !== voiceId);
    
    // 从下拉菜单中删除
    const dropdown = document.getElementById('voiceId');
    const options = dropdown.querySelectorAll('option');
    
    for (let i = 0; i < options.length; i++) {
      if (options[i].value === voiceId) {
        dropdown.removeChild(options[i]);
        break;
      }
    }
    
    // 保存并更新UI
    saveCustomVoices();
    updateCustomVoiceListUI();
    
    // 更新音色列表显示
    displayAllAvailableVoiceIds();
    
    logMessage(`已删除音色: ${voiceId}`, "info");
  }
}

// 格式化日期
function formatDate(date) {
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// 清除日志
function clearLogs() {
  const logs = document.getElementById('logs');
  logs.innerHTML = '<div class="log-entry log-info">日志已清除...</div>';
}

// 添加日志
function logMessage(message, type = "info") {
  console.log(`[${type}] ${message}`);
  
  const timestamp = new Date().toLocaleTimeString();
  const logs = document.getElementById('logs');
  const entry = document.createElement('div');
  entry.className = `log-entry log-${type}`;
  entry.textContent = `[${timestamp}] ${message}`;
  logs.appendChild(entry);
  logs.scrollTop = logs.scrollHeight;
}

// 生成语音
function generateSpeech() {
  try {
    // 获取文本内容
    const text = document.getElementById('textContent').value;
    if (!text) {
      logMessage("请输入要转换为语音的文本", "error");
      return;
    }
    
    // 获取设置
    const apiKey = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiLoi4_mmI4iLCJVc2VyTmFtZSI6IuiLj-aYjiIsIkFjY291bnQiOiIiLCJTdWJqZWN0SUQiOiIxOTEyNjc4NjAwODM5MDEyOTY1IiwiUGhvbmUiOiIxNTExNjkwNTA2MiIsIkdyb3VwSUQiOiIxOTEyNjc4NjAwODMwNjI0MzU3IiwiUGFnZU5hbWUiOiIiLCJNYWlsIjoiIiwiQ3JlYXRlVGltZSI6IjIwMjUtMDQtMTkgMTE6MDQ6MzMiLCJUb2tlblR5cGUiOjEsImlzcyI6Im1pbmltYXgifQ.V_YhYLmgyfnAV3ssptSqTKHiUjuqbQq62FZBCsRJgtUobIMCJuZYtxHuBtOcJot6VeKLjUXZtECPrjqGTR6MfViYujZC-HdXcUxUtVW3Z59_hHr2UWVnLUGLl0CQoiM0-QtEOa2KL3-VCo7iffhSnusNiYX9LF44iefN0AOEdKuMlmj8NejFPCamusQ1soCwIto2dT3oCkPSm8IOPWs4qej_jgc07yGRiZVFIfBOFO8opiWrzu9z43KGACQsbAAzdxLFKbm3P_uwSjrVNTBxOI8FXGXYBBR3zIOJT-9rwtRq-k9CnITKyo4_YyAmmD29ps_Q6etakd1KJBFfgZN5Bg';
    const groupId = '1912678600830624357';
    const apiEndpoint = 'https://api.minimax.chat/v1/t2a_v2';
    
    // 获取语音参数
    const model = document.getElementById('model').value;
    const voiceId = document.getElementById('voiceId').value;
    const speed = parseFloat(document.getElementById('speed').value);
    const vol = parseFloat(document.getElementById('vol').value);
    const pitch = parseInt(document.getElementById('pitch').value);
    const emotion = document.getElementById('emotion').value;
    const format = document.getElementById('outputFormat').value;
    const latexRead = document.getElementById('latexRead').checked;
    const englishNormalization = document.getElementById('englishNormalization').checked;
    
    // 更新按钮状态
    const generateBtn = document.getElementById('generateBtn');
    const originalBtnText = generateBtn.textContent;
    generateBtn.innerHTML = '<span class="spinner"></span>生成中...';
    generateBtn.disabled = true;
    
    // 记录生成信息
    logMessage(`开始生成语音，文本长度: ${text.length}字符`, "info");
    logMessage(`使用模型: ${model}, 音色: ${voiceId}, 语速: ${speed}, 音量: ${vol}, 语调: ${pitch}`, "info");
    
    // 准备请求数据
    const requestData = {
      model: model,
      text: text,
      stream: false,
      voice_setting: {
        voice_id: voiceId,
        speed: speed,
        vol: vol,
        pitch: pitch
      },
      audio_setting: {
        sample_rate: 32000,
        bitrate: 128000,
        format: format,
        channel: 1
      }
    };
    
    // 添加可选参数
    if (emotion) {
      requestData.voice_setting.emotion = emotion;
      logMessage(`使用情绪: ${emotion}`, "info");
    }
    
    if (latexRead) {
      requestData.latex_read = true;
      logMessage("启用LaTeX公式朗读", "info");
    }
    
    if (englishNormalization) {
      requestData.english_normalization = true;
      logMessage("启用英语文本规范化", "info");
    }
    
    // 构建请求URL
    const apiUrl = `${apiEndpoint}?GroupId=${groupId}`;
    
    // 记录请求信息
    logMessage("正在发送请求...", "info");
    
    // 使用XMLHttpRequest发送请求
    const xhr = new XMLHttpRequest();
    xhr.open('POST', apiUrl, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
    xhr.responseType = 'text';
    
    xhr.onload = function() {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const response = JSON.parse(xhr.responseText);
          
          // 检查API响应
          if (response.base_resp && response.base_resp.status_code !== 0) {
            throw new Error(`API返回错误: ${response.base_resp.status_msg}`);
          }
          
          if (!response.data || !response.data.audio) {
            throw new Error("API响应中未找到音频数据");
          }
          
          // 处理音频数据
          const audioHex = response.data.audio;
          logMessage(`接收到音频数据，长度: ${audioHex.length} 字符`, "debug");
          
          // 转换十六进制为ArrayBuffer
          const audioBytes = hexToArrayBuffer(audioHex);
          currentAudioBlob = new Blob([audioBytes], { type: `audio/${format}` });
          const audioUrl = URL.createObjectURL(currentAudioBlob);
          
          // 设置音频播放器
          const audioPlayer = document.getElementById('audioPlayer');
          audioPlayer.src = audioUrl;
          document.getElementById('audioContainer').style.display = 'block';
          audioPlayer.play();
          
          // 如果使用的是克隆音色，更新克隆音色的使用时间
          if (isCustomVoice(voiceId)) {
            updateCustomVoiceUsage(voiceId);
          }
          
          logMessage("语音生成成功!", "success");
          
        } catch (e) {
          logMessage(`错误: ${e.message}`, "error");
        }
      } else {
        const errorText = xhr.responseText || '无响应数据';
        logMessage(`HTTP错误: ${xhr.status}`, "error");
        logMessage(`错误响应: ${errorText.substring(0, 200)}`, "debug");
      }
      
      // 恢复按钮状态
      generateBtn.textContent = originalBtnText;
      generateBtn.disabled = false;
    };
    
    xhr.onerror = function() {
      logMessage("网络错误，请求失败", "error");
      generateBtn.textContent = originalBtnText;
      generateBtn.disabled = false;
    };
    
    xhr.ontimeout = function() {
      logMessage("请求超时", "error");
      generateBtn.textContent = originalBtnText;
      generateBtn.disabled = false;
    };
    
    // 设置超时（10秒）
    xhr.timeout = 10000;
    
    // 发送请求
    xhr.send(JSON.stringify(requestData));
    
  } catch (error) {
    logMessage(`错误: ${error.message}`, "error");
    console.error(error);
    
    // 恢复按钮状态
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.textContent = '生成语音';
    generateBtn.disabled = false;
  }
}

// 将十六进制字符串转换为ArrayBuffer
function hexToArrayBuffer(hexString) {
  // 确保长度是偶数
  if (hexString.length % 2 !== 0) {
    hexString = '0' + hexString;
  }
  
  const bytes = new Uint8Array(hexString.length / 2);
  for (let i = 0; i < hexString.length; i += 2) {
    bytes[i / 2] = parseInt(hexString.substring(i, i + 2), 16);
  }
  return bytes.buffer;
}

// 下载音频
function downloadAudio() {
  if (!currentAudioBlob) {
    logMessage("没有可下载的音频", "error");
    return;
  }
  
  try {
    const url = URL.createObjectURL(currentAudioBlob);
    const a = document.createElement('a');
    a.href = url;
    const format = document.getElementById('outputFormat').value || 'mp3';
    a.download = `tts_${new Date().toISOString().replace(/[:.]/g, '-')}.${format}`;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    
    logMessage(`音频下载已开始: ${a.download}`, "info");
  } catch (error) {
    logMessage(`下载音频时出错: ${error.message}`, "error");
  }
}

// 重复播放
function repeatPlayback() {
  const audioPlayer = document.getElementById('audioPlayer');
  audioPlayer.currentTime = 0;
  audioPlayer.play();
  logMessage("重新开始播放音频", "info");
}

// 添加新函数：显示所有可用的音色ID（包括预设和克隆的）
function displayAllAvailableVoiceIds() {
  const voiceDropdown = document.getElementById('voiceId');
  const allVoices = [];
  
  // 获取下拉菜单中的所有选项
  for (let i = 0; i < voiceDropdown.options.length; i++) {
    allVoices.push({
      id: voiceDropdown.options[i].value,
      name: voiceDropdown.options[i].textContent,
      isCustom: voiceDropdown.options[i].textContent.includes('克隆音色')
    });
  }
  
  // 记录到控制台
  console.table(allVoices);
  
  // 创建音色ID表格显示在页面上
  const voiceListContainer = document.getElementById('voiceListContainer');
  if (!voiceListContainer) {
    // 如果容器不存在，创建一个
    const container = document.createElement('div');
    container.id = 'voiceListContainer';
    container.className = 'section';
    container.style.marginTop = '20px';
    container.innerHTML = `
      <h3 class="section-title">所有可用音色列表</h3>
      <div class="form-group">
        <button onclick="toggleVoiceListVisibility()" class="secondary-btn">显示/隐藏音色列表</button>
        <div id="allVoicesList" style="margin-top: 10px; display: none; max-height: 300px; overflow-y: auto;"></div>
      </div>
    `;
    
    // 找到合适的位置插入这个容器
    const formContainer = document.querySelector('.container');
    const audioContainer = document.getElementById('audioContainer');
    if (audioContainer) {
      formContainer.insertBefore(container, audioContainer.nextSibling);
    } else {
      formContainer.appendChild(container);
    }
  }
  
  // 更新音色列表内容
  const allVoicesList = document.getElementById('allVoicesList');
  if (allVoicesList) {
    let tableHtml = `
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f7ff;">音色ID</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f7ff;">音色名称</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #f2f7ff;">类型</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    allVoices.forEach(voice => {
      tableHtml += `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;"><code>${voice.id}</code></td>
          <td style="border: 1px solid #ddd; padding: 8px;">${voice.name}</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
            ${voice.isCustom ? 
              '<span style="color: #4285f4; font-weight: bold;">克隆</span>' : 
              '<span style="color: #34a853;">预设</span>'}
          </td>
        </tr>
      `;
    });
    
    tableHtml += `
        </tbody>
      </table>
    `;
    
    allVoicesList.innerHTML = tableHtml;
    
    // 显示音色数量
    logMessage(`系统中共有 ${allVoices.length} 个音色，其中预设音色 ${allVoices.filter(v => !v.isCustom).length} 个，克隆音色 ${allVoices.filter(v => v.isCustom).length} 个`, "info");
    
    // 自动显示列表
    allVoicesList.style.display = 'block';
  }
}

// 添加切换音色列表显示/隐藏的函数
function toggleVoiceListVisibility() {
  const allVoicesList = document.getElementById('allVoicesList');
  if (allVoicesList) {
    if (allVoicesList.style.display === 'none') {
      allVoicesList.style.display = 'block';
    } else {
      allVoicesList.style.display = 'none';
    }
  }
}

// 显示所有克隆的音色ID
function displayAllClonedVoiceIds() {
  if (customVoices.length === 0) {
    logMessage("暂无克隆音色，请先使用上方表单创建", "warning");
    return;
  }
  
  logMessage("正在显示已克隆的音色ID列表...", "info");
  
  // 创建对话框
  const dialogOverlay = document.createElement('div');
  dialogOverlay.style.position = 'fixed';
  dialogOverlay.style.top = '0';
  dialogOverlay.style.left = '0';
  dialogOverlay.style.width = '100%';
  dialogOverlay.style.height = '100%';
  dialogOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
  dialogOverlay.style.zIndex = '1000';
  dialogOverlay.style.display = 'flex';
  dialogOverlay.style.justifyContent = 'center';
  dialogOverlay.style.alignItems = 'center';
  
  // 对话框内容
  const dialogContent = document.createElement('div');
  dialogContent.style.backgroundColor = 'white';
  dialogContent.style.borderRadius = '8px';
  dialogContent.style.padding = '20px';
  dialogContent.style.width = '80%';
  dialogContent.style.maxWidth = '600px';
  dialogContent.style.maxHeight = '80%';
  dialogContent.style.overflow = 'auto';
  dialogContent.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
  
  // 对话框标题
  const dialogTitle = document.createElement('h3');
  dialogTitle.style.borderBottom = '1px solid #eee';
  dialogTitle.style.paddingBottom = '10px';
  dialogTitle.style.marginTop = '0';
  dialogTitle.textContent = `已克隆的音色ID列表 (共${customVoices.length}个)`;
  
  // 音色列表
  const voiceTable = document.createElement('table');
  voiceTable.style.width = '100%';
  voiceTable.style.borderCollapse = 'collapse';
  voiceTable.style.marginBottom = '15px';
  
  // 表头
  const tableHead = document.createElement('thead');
  tableHead.innerHTML = `
    <tr>
      <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f7ff;">序号</th>
      <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f7ff;">音色ID</th>
      <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #f2f7ff;">状态</th>
      <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: #f2f7ff;">创建时间</th>
    </tr>
  `;
  
  // 表格内容
  const tableBody = document.createElement('tbody');
  
  customVoices.forEach((voice, index) => {
    const lastUsedDate = new Date(voice.lastUsed);
    const createdDate = new Date(voice.createdAt);
    const isUsed = lastUsedDate > createdDate;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
      <td style="border: 1px solid #ddd; padding: 8px;"><code>${voice.id}</code></td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${isUsed ? '#4285f4' : '#ff6d00'};">
        ${isUsed ? "已永久保存" : "未使用过"}
      </td>
      <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
        ${formatDate(createdDate)}
      </td>
    `;
    
    tableBody.appendChild(row);
  });
  
  voiceTable.appendChild(tableHead);
  voiceTable.appendChild(tableBody);
  
  // 创建一个纯文本区域显示所有ID，方便复制
  const textArea = document.createElement('textarea');
  textArea.readOnly = true;
  textArea.style.width = '100%';
  textArea.style.height = '100px';
  textArea.style.marginBottom = '15px';
  textArea.style.padding = '8px';
  textArea.style.border = '1px solid #ddd';
  textArea.style.borderRadius = '4px';
  textArea.value = customVoices.map(v => v.id).join('\n');
  
  // 按钮区域
  const buttonArea = document.createElement('div');
  buttonArea.style.display = 'flex';
  buttonArea.style.justifyContent = 'flex-end';
  buttonArea.style.gap = '10px';
  
  // 复制按钮
  const copyButton = document.createElement('button');
  copyButton.textContent = '复制所有ID';
  copyButton.className = 'success-btn';
  copyButton.onclick = function() {
    textArea.select();
    document.execCommand('copy');
    copyButton.textContent = '已复制！';
    setTimeout(() => {
      copyButton.textContent = '复制所有ID';
    }, 2000);
  };
  
  // 关闭按钮
  const closeButton = document.createElement('button');
  closeButton.textContent = '关闭';
  closeButton.className = 'secondary-btn';
  closeButton.onclick = function() {
    document.body.removeChild(dialogOverlay);
  };
  
  // 组合对话框
  buttonArea.appendChild(copyButton);
  buttonArea.appendChild(closeButton);
  
  dialogContent.appendChild(dialogTitle);
  dialogContent.appendChild(voiceTable);
  dialogContent.appendChild(document.createElement('hr'));
  
  // 添加说明文字
  const helpText = document.createElement('p');
  helpText.style.marginBottom = '10px';
  helpText.style.color = '#666';
  helpText.textContent = '以下是所有克隆音色ID的列表，可以直接复制使用：';
  
  dialogContent.appendChild(helpText);
  dialogContent.appendChild(textArea);
  dialogContent.appendChild(buttonArea);
  
  dialogOverlay.appendChild(dialogContent);
  document.body.appendChild(dialogOverlay);
  
  // 点击背景关闭对话框
  dialogOverlay.addEventListener('click', function(e) {
    if (e.target === dialogOverlay) {
      document.body.removeChild(dialogOverlay);
    }
  });
}
</script>
</body>
</html>